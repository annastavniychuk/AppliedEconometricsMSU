<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.353">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Прикладная эконометрика - 7&nbsp; Регуляризация и большая размерность</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./heterogenous_treatment_effects.html" rel="next">
<link href="./matching.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./high_dimension_regularization.html"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Регуляризация и большая размерность</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Прикладная эконометрика</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="mailto:annastavnychuk@gmail.com" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-at"></i></a>
    <a href="https://github.com/annastavniychuk" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Предисловие</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./experiments.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Эксперименты</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./multiple_testing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Множественное тестирование гипотез</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./bad_control.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Плохой контроль</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./prestratification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Престратификация</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./subclassification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Взвешивание (subclassification)</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./matching.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Мэтчинг</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./high_dimension_regularization.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Регуляризация и большая размерность</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./heterogenous_treatment_effects.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Гетерогенные эффекты</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./regression_discontinuity.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Разрывная регрессия</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./spatial_regression_discontinuity.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Пространственная разрывная регрессия</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./synthetic_control.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Синтетический контроль</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./staggered_adoption.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Ступенчатая разность разностей</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./event_study.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Событийный анализ</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Ссылки</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#что-такое-регуляризация" id="toc-что-такое-регуляризация" class="nav-link active" data-scroll-target="#что-такое-регуляризация"><span class="header-section-number">7.1</span> Что такое регуляризация?</a>
  <ul class="collapse">
  <li><a href="#ридж-регрессия-ridge" id="toc-ридж-регрессия-ridge" class="nav-link" data-scroll-target="#ридж-регрессия-ridge"><span class="header-section-number">7.1.1</span> Ридж-регрессия (ridge)</a></li>
  <li><a href="#lasso-регрессия" id="toc-lasso-регрессия" class="nav-link" data-scroll-target="#lasso-регрессия"><span class="header-section-number">7.1.2</span> LASSO регрессия</a></li>
  <li><a href="#метод-эластичной-сети-elastic-net" id="toc-метод-эластичной-сети-elastic-net" class="nav-link" data-scroll-target="#метод-эластичной-сети-elastic-net"><span class="header-section-number">7.1.3</span> Метод эластичной сети (Elastic Net)</a></li>
  </ul></li>
  <li><a href="#как-выбрать-коэффициент-регуляризации" id="toc-как-выбрать-коэффициент-регуляризации" class="nav-link" data-scroll-target="#как-выбрать-коэффициент-регуляризации"><span class="header-section-number">7.2</span> Как выбрать коэффициент регуляризации?</a>
  <ul class="collapse">
  <li><a href="#k-fold" id="toc-k-fold" class="nav-link" data-scroll-target="#k-fold"><span class="header-section-number">7.2.1</span> k-Fold</a></li>
  <li><a href="#кросс-валидация-временных-рядов" id="toc-кросс-валидация-временных-рядов" class="nav-link" data-scroll-target="#кросс-валидация-временных-рядов"><span class="header-section-number">7.2.2</span> Кросс-валидация временных рядов</a></li>
  </ul></li>
  <li><a href="#фильтр-ходрика-прескота" id="toc-фильтр-ходрика-прескота" class="nav-link" data-scroll-target="#фильтр-ходрика-прескота"><span class="header-section-number">7.3</span> Фильтр Ходрика-Прескота</a></li>
  <li><a href="#double-lasso" id="toc-double-lasso" class="nav-link" data-scroll-target="#double-lasso"><span class="header-section-number">8</span> Double LASSO</a>
  <ul class="collapse">
  <li><a href="#double-selection" id="toc-double-selection" class="nav-link" data-scroll-target="#double-selection"><span class="header-section-number">8.1</span> Double selection</a></li>
  <li><a href="#partialling-out" id="toc-partialling-out" class="nav-link" data-scroll-target="#partialling-out"><span class="header-section-number">8.2</span> Partialling-out</a></li>
  </ul></li>
  <li><a href="#пример" id="toc-пример" class="nav-link" data-scroll-target="#пример"><span class="header-section-number">9</span> Пример</a>
  <ul class="collapse">
  <li><a href="#lasso" id="toc-lasso" class="nav-link" data-scroll-target="#lasso"><span class="header-section-number">9.1</span> LASSO</a>
  <ul class="collapse">
  <li><a href="#подготовка" id="toc-подготовка" class="nav-link" data-scroll-target="#подготовка"><span class="header-section-number">9.1.1</span> Подготовка</a></li>
  <li><a href="#оценивание" id="toc-оценивание" class="nav-link" data-scroll-target="#оценивание"><span class="header-section-number">9.1.2</span> Оценивание</a></li>
  <li><a href="#диагностика" id="toc-диагностика" class="nav-link" data-scroll-target="#диагностика"><span class="header-section-number">9.1.3</span> Диагностика</a></li>
  <li><a href="#кросс-валидация" id="toc-кросс-валидация" class="nav-link" data-scroll-target="#кросс-валидация"><span class="header-section-number">9.1.4</span> Кросс-валидация</a></li>
  </ul></li>
  <li><a href="#ridge" id="toc-ridge" class="nav-link" data-scroll-target="#ridge"><span class="header-section-number">9.2</span> Ridge</a>
  <ul class="collapse">
  <li><a href="#оценивание-1" id="toc-оценивание-1" class="nav-link" data-scroll-target="#оценивание-1"><span class="header-section-number">9.2.1</span> Оценивание</a></li>
  <li><a href="#диагностика-1" id="toc-диагностика-1" class="nav-link" data-scroll-target="#диагностика-1"><span class="header-section-number">9.2.2</span> Диагностика</a></li>
  <li><a href="#кросс-валидация-1" id="toc-кросс-валидация-1" class="nav-link" data-scroll-target="#кросс-валидация-1"><span class="header-section-number">9.2.3</span> Кросс-валидация</a></li>
  </ul></li>
  <li><a href="#double-lasso-1" id="toc-double-lasso-1" class="nav-link" data-scroll-target="#double-lasso-1"><span class="header-section-number">9.3</span> Double LASSO</a>
  <ul class="collapse">
  <li><a href="#способ-1-с-помощью-пакета" id="toc-способ-1-с-помощью-пакета" class="nav-link" data-scroll-target="#способ-1-с-помощью-пакета"><span class="header-section-number">9.3.1</span> Способ 1 (с помощью пакета)</a></li>
  <li><a href="#способ-2-double-selection-руками" id="toc-способ-2-double-selection-руками" class="nav-link" data-scroll-target="#способ-2-double-selection-руками"><span class="header-section-number">9.3.2</span> Способ 2 (Double selection руками)</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Регуляризация и большая размерность</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="что-такое-регуляризация" class="level2" data-number="7.1">
<h2 data-number="7.1" class="anchored" data-anchor-id="что-такое-регуляризация"><span class="header-section-number">7.1</span> Что такое регуляризация?</h2>
<p><strong>Зачем нужна регуляризация?</strong></p>
<ul>
<li>очень много ковариат, которые нужно как-то отобрать, а другие способы не подходят</li>
<li>проблема мультиколинеарности</li>
<li>снижение размерности</li>
<li>переобучение</li>
<li>фильтры</li>
<li>информационные критерии Акаике и Шварца</li>
</ul>
<p>Предположим, что мы находимся в ситуации мультиколинеарности.</p>
<ul>
<li>Строгая мультиколинеарность создает проблему неедиснтвенности МНК-оценок.</li>
<li>При нестрогой мультиколинеарности оценки все еще являются несмещенными и асимптотически нормальными, однако стандартные ошибки в такой модели будут больше. Это приводит к широким доверительным интервалам и незначимым оценкам.</li>
</ul>
<p>Тогда у нас есть 2 варианта, как с ней бороться. Первый – выбросить часть регрессоров, снизив дисперсию оценок и пожертвовав несмещенностью. Второй – использовать регуляризацию (МНК со штрафной функцией) – включение штрафа в сумму наименьших квадратов. Этот способ, однако, тоже несколько смещает оценки и порождает дилему смещения и дисперсии (bias–variance tradeoff).</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="high_dimension_regularization_plots/variance-bias-plot.jpg" class="img-fluid figure-img" style="width:70.0%"></p>
<figcaption class="figure-caption">Bias–variance tradeoff</figcaption>
</figure>
</div>
<p>Исходная постановка МНК:</p>
<p><span class="math display">\[
\begin{aligned}
&amp;\min _{\hat{\beta}_j} ESS = \min _{\hat{\beta}_j} \sum_{i=1}^{n} e_i^2 = \min _{\hat{\beta}_j} \sum_{i=1}^{n} \left(y_{i}-\hat{y}_{i}\right)^{2} =  \min _{\hat{\beta}_j} \sum_{i=1}^{n} \left(y_{i}-\hat{\beta}_1 - \hat{\beta_2}\cdot x_i - ...\right)^{2}
\end{aligned}
\]</span></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="high_dimension_regularization_plots/1_kxgDRZwes0v2HQrvBh-c3A.png" class="img-fluid figure-img" style="width:70.0%"></p>
<figcaption class="figure-caption">Bias–variance tradeoff</figcaption>
</figure>
</div>
<p>Если построить график суммы квадратов остатков в зависимости от величины коэффициентов, то он и его линии уровня будут выглядеить следующим образом:</p>
<div class="quarto-layout-panel">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="quarto-layout-cell" style="flex-basis: 70.0%;justify-content: center;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="high_dimension_regularization_plots/1_GagrtxPolqxlCR6ZP6CB7w.jpeg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">График ESS</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 30.0%;justify-content: center;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="high_dimension_regularization_plots/1_XoMLocfIZd_HF73M45DQeA.jpeg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Линии уровня ESS</figcaption>
</figure>
</div>
</div>
</div>
</div>
<p>Регуляризация фактически является задачей Лагранжа, которую вы много раз решали. В исходную оптимизационную задачу мы добавляем дополнительное ограничение, чтобы оценки были не очень большими. Тогда <span class="math inline">\(\lambda\)</span> является множителем Лагранжа (но в этот раз для нас более важно, что это коэффициент регуляризации).</p>
<p>В общем виде постановка задачи регуляризации выглядит следующим образом:</p>
<p><span class="math display">\[
\begin{aligned}
&amp;\min _{\hat{\beta}_j} ESS + \text{штраф}
\end{aligned}
\]</span></p>
<p>В зависимости от того, какую штрафную функцию мы используем, выделяют несколько основных видов регуляризации:</p>
<ul>
<li>Ридж-регрессия</li>
<li>Регрессия лассо</li>
<li>Метод эластичной сети</li>
</ul>
<section id="ридж-регрессия-ridge" class="level3" data-number="7.1.1">
<h3 data-number="7.1.1" class="anchored" data-anchor-id="ридж-регрессия-ridge"><span class="header-section-number">7.1.1</span> Ридж-регрессия (ridge)</h3>
<p>Иногда еще называют L2 или регуляризация Тихонова (почему именно L2 можно почитать <a href="https://habr.com/ru/company/ods/blog/322076/">тут</a>). В качестве функции штрафа используется сумма квадратов оценок коэффициентов:</p>
<p><span class="math display">\[
\begin{aligned}
&amp;\min _{\hat{\beta}_j} \sum_{i=1}^{n}\left(y_{i}-\hat{y}_{i}\right)^{2}+\lambda\left(\hat{\beta}_{1}^{2}+\hat{\beta}_{2}^{2}+\ldots+\hat{\beta}_{k}^{2}\right)
\end{aligned}
\]</span></p>
<p><span class="math display">\[
\begin{aligned}
\begin{cases}
&amp;\sum_{i=1}^{n}\left(y_{i}-\hat{y}_{i}\right)^{2} \rightarrow \underset{\hat{\beta}_j}{\min} \\
&amp;\hat{\beta}_{1}^{2}+\hat{\beta}_{2}^{2}+\ldots+\hat{\beta}_{k}^{2} \leq t
\end{cases}
\end{aligned}
\]</span> А такую задачу мы умеем решать графически!</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="high_dimension_regularization_plots/1_VNq12fddW4O25KyLy-JgBw.jpeg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Rigge</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="high_dimension_regularization_plots/image_2021-01-28_02-30-20.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Сравнение LASSO и Rigge</figcaption>
</figure>
</div>
</section>
<section id="lasso-регрессия" class="level3" data-number="7.1.2">
<h3 data-number="7.1.2" class="anchored" data-anchor-id="lasso-регрессия"><span class="header-section-number">7.1.2</span> LASSO регрессия</h3>
<p>Иногда еще называют L1 или регуляризация через манхэттенское расстояние. В качестве функции штрафа используется сумма модулей оценок коэффициентов:</p>
<p><span class="math display">\[
\begin{aligned}
&amp;\min _{\hat{\beta}_j} \sum_{i=1}^{n}\left(y_{i}-\hat{y}_{i}\right)^{2}+\lambda\left(\left|\hat{\beta}_{1}\right|+\left|\hat{\beta}_{2}\right|+\ldots+\left|\hat{\beta}_{k}\right|\right)
\end{aligned}
\]</span></p>
<p><span class="math display">\[
\begin{aligned}
\begin{cases}
&amp;\sum_{i=1}^{n}\left(y_{i}-\hat{y}_{i}\right)^{2} \rightarrow \underset{\hat{\beta}_j}{\min} \\
&amp;\left|\hat{\beta}_{1}\right|+\left|\hat{\beta}_{2}\right|+\ldots+\left|\hat{\beta}_{k}\right| \leq t
\end{cases}
\end{aligned}
\]</span></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="high_dimension_regularization_plots/1_iz4AZmNJGWNzOX5P-SmW4A.jpeg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">LASSO</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="high_dimension_regularization_plots/main-qimg-cd536c849f93739a27ae763d7ee31c20-lq.jpeg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Сравнение LASSO и Rigge</figcaption>
</figure>
</div>
<p>Как правило, LASSO чаще приводит к занулению коэффициентов, чем Ridge, это обусловлено геометрией регуляризационного ограничения:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="high_dimension_regularization_plots/1_GSQfWiZolZzSJfGTRaDnMg.jpeg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Сравнение LASSO и Rigge</figcaption>
</figure>
</div>
</section>
<section id="метод-эластичной-сети-elastic-net" class="level3" data-number="7.1.3">
<h3 data-number="7.1.3" class="anchored" data-anchor-id="метод-эластичной-сети-elastic-net"><span class="header-section-number">7.1.3</span> Метод эластичной сети (Elastic Net)</h3>
<p>Комбинацией LASSO и Rigge регрессий является метод эластичной сети.</p>
<p><span class="math display">\[
\min _{\hat{\beta}_j} \sum_{i=1}^{n}\left(y_{i}-\hat{y}_{i}\right)^{2}+\lambda_{1} \sum_{j=1}^{k}\left|\hat{\beta}_{j}\right|+\lambda_{2} \sum_{j=1}^{k} \hat{\beta}_{j}^{2}
\]</span></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="high_dimension_regularization_plots/1_Ri5Jj6mFqeHpeJXiFnwUgA.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Сравнение LASSO, Rigge и Elastic Net</figcaption>
</figure>
</div>
</section>
</section>
<section id="как-выбрать-коэффициент-регуляризации" class="level2" data-number="7.2">
<h2 data-number="7.2" class="anchored" data-anchor-id="как-выбрать-коэффициент-регуляризации"><span class="header-section-number">7.2</span> Как выбрать коэффициент регуляризации?</h2>
<p>Это делают с помощью кросс валидации (cross validation). Как правило, почти всегда, когда говорят о кросс-валидации, имеют в виду метод k-Fold.</p>
<section id="k-fold" class="level3" data-number="7.2.1">
<h3 data-number="7.2.1" class="anchored" data-anchor-id="k-fold"><span class="header-section-number">7.2.1</span> k-Fold</h3>
<ul>
<li>Выбираем <span class="math inline">\(m\)</span> штук <span class="math inline">\(\lambda\)</span>, которые будем проверять;</li>
<li>Фиксируем одну из <span class="math inline">\(\lambda\)</span>;</li>
<li>Вся выборка разделяется на k частей (k - произвольное число, часто от 5 до 10, на картинке внизу как раз 10). В машинке эти части называют фолдами;</li>
<li>Далее происходит k итераций, во время каждой из которых один фолд выступает в роли тестового множества, а объединение остальных — в роли обучающего. Модель оценивается на k−1 фолде и тестируется на оставшемся. На каждом шаге итерации на тестовом фолде считается метрика качества подгонки, например, MSE (mean squared error);</li>
<li>Далее k получившихся метрик агрегируются в финальный общий показатель качества модели для зафиксированной <span class="math inline">\(\lambda\)</span>, например считается средняя MSE из k штук;</li>
<li>Повторяем процедуру для всех <span class="math inline">\(m\)</span> штук <span class="math inline">\(\lambda\)</span>;</li>
<li>Выбираем <span class="math inline">\(\lambda\)</span> с минимальным финальным общим показателем <span class="math inline">\(\overline{MSE}\)</span>.</li>
</ul>
<p><span class="math display">\[
MSE_j = \frac{1}{n_j}\sum \left(y_i - \hat{m}^{(-j)}(x_i)\right)^2
\]</span></p>
<p><span class="math display">\[
\overline{MSE}_{\lambda_m} = \frac{1}{k}\sum_{j=1}^k MSE_j
\]</span> <span class="math display">\[
\lambda^* = \underset{\lambda_m}{argmin}\{\overline{MSE}_{\lambda_1}, ... , \overline{MSE}_{\lambda_m}\}
\]</span></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="high_dimension_regularization_plots/Cross-validation-k-fold.jpg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">k-Fold</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="high_dimension_regularization_plots/ii3.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">k-Fold алгоритм</figcaption>
</figure>
</div>
</section>
<section id="кросс-валидация-временных-рядов" class="level3" data-number="7.2.2">
<h3 data-number="7.2.2" class="anchored" data-anchor-id="кросс-валидация-временных-рядов"><span class="header-section-number">7.2.2</span> Кросс-валидация временных рядов</h3>
<p>Кросс-валидация моделей для временных рдов осложняется тем, что данные не должны пересекаться по времени: обучающие данные должны идти до тестовых. С учётом этих особенностей фолды в кросс-валидации для временных рядов располагаются вдоль временной оси так, как показано на следующей картинке:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="high_dimension_regularization_plots/time_series_cv.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Кросс-валидация временных рядов</figcaption>
</figure>
</div>
</section>
</section>
<section id="фильтр-ходрика-прескота" class="level2" data-number="7.3">
<h2 data-number="7.3" class="anchored" data-anchor-id="фильтр-ходрика-прескота"><span class="header-section-number">7.3</span> Фильтр Ходрика-Прескота</h2>
<p>По сути формазизация задачи выделения тренда с помощью фильтра Ходрика-Прескота является регуляризацией. Мы ищем компромисс между точностью описания временного ряда и его гладкостью (тренд предыдущего периода должен быть похож на тренд текущего):</p>
<p><span class="math display">\[
\begin{aligned}
&amp;\min_{g} \underbrace{\sum_{t=1}^{T}\left(y_{t}-g_{t}\right)^{2}}_{\text{точность описания}}+ \lambda\underbrace{\sum_{t=2}^{T-1} \left[\left(g_{t+1}-g_t\right)-(g_t-g_{t-1})\right]^2}_{\text{гладкость тренда}}
\end{aligned}
\]</span> где <span class="math inline">\(y_t\)</span> – изучаемый временной ряд, <span class="math inline">\(g_t\)</span> – выделяемый тренд.</p>
<ul>
<li>если <span class="math inline">\(\lambda=0\)</span>, то <span class="math inline">\(y_t=g_t\)</span>;</li>
<li>если <span class="math inline">\(\lambda=\infty\)</span>, то <span class="math inline">\(g_{t+1}=g_t=g_{t-1}\)</span>, то есть получим линейный тренд.</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="high_dimension_regularization_plots/SetSmoothingParameterExample_02.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Фильтр Ходрика-Прескота с разным гиперпараметром</figcaption>
</figure>
</div>
</section>
<section id="double-lasso" class="level1" data-number="8">
<h1 data-number="8"><span class="header-section-number">8</span> Double LASSO</h1>
<p>Живем в ситуации unconfoundedness <span class="math inline">\(T_i \perp Y_{i1}, Y_{i0} | X_i\)</span></p>
<section id="double-selection" class="level2" data-number="8.1">
<h2 data-number="8.1" class="anchored" data-anchor-id="double-selection"><span class="header-section-number">8.1</span> Double selection</h2>
<ul>
<li>Выбираем набор переменных с помощью LASSO
<ul>
<li><span class="math inline">\(Y\sim X\)</span>, получаем <span class="math inline">\(\hat{\beta}_j^Y \neq 0\)</span>, оставляем эти иксы;</li>
</ul></li>
<li>Выбираем набор переменных с помощью LASSO
<ul>
<li><span class="math inline">\(T\sim X\)</span>, получаем <span class="math inline">\(\hat{\beta}_j^T \neq 0\)</span>, оставляем эти иксы;</li>
</ul></li>
<li>Финальная регрессия (иногда называют post LASSO OLS)
<ul>
<li><span class="math inline">\(Y \sim T + \text{отобранные на прошлых шагах } X\)</span>, получаем <span class="math inline">\(\hat{\tau}^{DL}=\hat{ATE}\)</span></li>
</ul></li>
</ul>
</section>
<section id="partialling-out" class="level2" data-number="8.2">
<h2 data-number="8.2" class="anchored" data-anchor-id="partialling-out"><span class="header-section-number">8.2</span> Partialling-out</h2>
<p>По теореме Фриша-Ву-Ловелла то же самое можно сделать с помощью другой процедуры.</p>
<ul>
<li>Выбираем набор переменных с помощью LASSO
<ul>
<li><span class="math inline">\(Y\sim X\)</span>, получаем <span class="math inline">\(\hat{\beta}_j^Y \neq 0\)</span>, оставляем эти иксы;</li>
</ul></li>
<li>Оцениваем регрессию <span class="math inline">\(Y\sim X\)</span> только на те <span class="math inline">\(X\)</span>, которые отобрали на прошлом шаге, где <span class="math inline">\(\hat{\beta}_j^Y \neq 0\)</span>. Получаем остатки модели <span class="math inline">\(e_i^Y\)</span>;</li>
<li>Выбираем набор переменных с помощью LASSO
<ul>
<li><span class="math inline">\(T\sim X\)</span>, получаем <span class="math inline">\(\hat{\beta}_j^T \neq 0\)</span>, оставляем эти иксы;</li>
</ul></li>
<li>Оцениваем регрессию <span class="math inline">\(T\sim X\)</span> только на те <span class="math inline">\(X\)</span>, которые отобрали на прошлом шаге, где <span class="math inline">\(\hat{\beta}_j^T \neq 0\)</span>. Получаем остатки модели <span class="math inline">\(e_i^T\)</span>;</li>
<li>Финальная регрессия остатков на остатки
<ul>
<li><span class="math inline">\(e_i^Y \sim e_i^T\)</span>, получаем <span class="math inline">\(\hat{\tau}^{DL}=\hat{ATE}\)</span></li>
</ul></li>
</ul>
</section>
</section>
<section id="пример" class="level1" data-number="9">
<h1 data-number="9"><span class="header-section-number">9</span> Пример</h1>
<p>В качестве примера использования регуляризации мы воспользуется работой <a href="http://dx.doi.org/10.2139/ssrn.3249624">(Veterinarov, Ivanov, 2018)</a>, которые изучали цену этнической дискриминации для арендодателей на рынке жилья. Авторы пытались оценить эффект наличия в объявлении дискриминирующих по этническому признаку формулировак на стоимость аренды квартир. Оказалось, что этническая дискриминация связана со значительным снижением цены.</p>
<p>Импортируем данные:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"high_dimension_regularization_data/table_cian_mos_ecm.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Набор данных включает следующие переменные:</p>
<ul>
<li><code>price</code> – цена аренды квартиры в рублях;</li>
<li><code>total_area</code> – общая площадь квартиры в квадратных метрах;<br>
</li>
<li><code>discrim_proxy</code> – наличие дискриминирующего текста в описании объявления;</li>
<li><code>*_rajon</code> – набор бинарных переменных, соотвествующих районам Москвы, где расположена квартира;</li>
<li><code>first_floor</code> – бинарная переменная, равная единице, если квартира расположена на первом этаже;</li>
<li><code>*_rooms</code> – набор бинарных переменных, соотвествующих количеству комнат в квартире;</li>
<li><code>starii_fond</code> – бинарная переменная, равная единице, если квартира принадлежит к старому жилому фонду;</li>
<li><code>blochnii</code> – бинарная переменная, равная единице, если квартира находится в блочном доме;</li>
<li><code>derevjannii</code> – бинарная переменная, равная единице, если квартира находится в деревянном доме;</li>
<li><code>kirpichnii</code> – бинарная переменная, равная единице, если квартира находится в кирпичном доме;</li>
<li><code>monolitnii</code> – бинарная переменная, равная единице, если квартира находится в монолитном доме;</li>
<li><code>panelnii</code> – бинарная переменная, равная единице, если квартира находится в кирпичном доме;</li>
<li><code>stalinskii</code> – бинарная переменная, равная единице, если квартира находится в сталинском доме;</li>
<li><code>repair</code> – бинарная переменная, равная единице, если в квартире сделан ремонт;</li>
<li><code>four_and_over_rooms</code> – бинарная переменная, равная единице, если в квартире четыре и более комнат.</li>
</ul>
<p>Создадим логарифмы площади и цены:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>log_total_area <span class="ot">&lt;-</span> <span class="fu">log</span>(data<span class="sc">$</span>total_area)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>log_price <span class="ot">&lt;-</span> <span class="fu">log</span>(data<span class="sc">$</span>price)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="lasso" class="level2" data-number="9.1">
<h2 data-number="9.1" class="anchored" data-anchor-id="lasso"><span class="header-section-number">9.1</span> LASSO</h2>
<section id="подготовка" class="level3" data-number="9.1.1">
<h3 data-number="9.1.1" class="anchored" data-anchor-id="подготовка"><span class="header-section-number">9.1.1</span> Подготовка</h3>
<p>Синтаксис функции, которую мы будем далее использовать, предполагает, что мы должны передавать ей зависимую переменную, контрольные переменные и формулу модели отдельными объектами. Поэтому нам нужно их заранее заготовить.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>formula <span class="ot">&lt;-</span> log_price <span class="sc">~</span> log_total_area <span class="sc">+</span> discrim_proxy <span class="sc">+</span> Mos_center <span class="sc">+</span> </span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  Akimanka_rajon <span class="sc">+</span> Hamovniki_rajon <span class="sc">+</span> Tverskoj_rajon <span class="sc">+</span> Taganskij_rajon <span class="sc">+</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  Krasnoselskij_rajon <span class="sc">+</span> Mesanskij_rajon <span class="sc">+</span> Zamoskvorece_rajon <span class="sc">+</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  Basmannyj_rajon <span class="sc">+</span> Arbat_rajon <span class="sc">+</span> first_floor <span class="sc">+</span> one_room <span class="sc">+</span> two_rooms <span class="sc">+</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  three_rooms <span class="sc">+</span> four_and_over_rooms <span class="sc">+</span> starii_fond <span class="sc">+</span> blochnii <span class="sc">+</span> </span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  derevjannii <span class="sc">+</span> kirpichnii <span class="sc">+</span> monolitnii <span class="sc">+</span> panelnii <span class="sc">+</span> stalinskii <span class="sc">+</span> repair <span class="co"># формула для регресии</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="at">data=</span>data,formula) <span class="co"># матрица для оценки модели</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Следующий шаг, который нам нужно выполнить, это решить, какую <span class="math inline">\(\lambda\)</span> мы будем использовать. Мы можем захотеть проверить сразу несколько, для этого создадим вектор, в который поместим все значения <span class="math inline">\(\lambda\)</span>, которые мы хотим перебрать:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>lambdas <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="at">length=</span><span class="dv">30</span>) <span class="co"># 10 штук от 0 до 1 с равными интервалами</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>lambdas </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 0.00000000 0.03448276 0.06896552 0.10344828 0.13793103 0.17241379
 [7] 0.20689655 0.24137931 0.27586207 0.31034483 0.34482759 0.37931034
[13] 0.41379310 0.44827586 0.48275862 0.51724138 0.55172414 0.58620690
[19] 0.62068966 0.65517241 0.68965517 0.72413793 0.75862069 0.79310345
[25] 0.82758621 0.86206897 0.89655172 0.93103448 0.96551724 1.00000000</code></pre>
</div>
</div>
</section>
<section id="оценивание" class="level3" data-number="9.1.2">
<h3 data-number="9.1.2" class="anchored" data-anchor-id="оценивание"><span class="header-section-number">9.1.2</span> Оценивание</h3>
<p>Регуляризация в <code>R</code> реализована в библиотеке <code>glmnet</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glmnet)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>model_lasso <span class="ot">&lt;-</span> <span class="fu">glmnet</span>(<span class="at">x=</span>X, <span class="co"># матрица иксов</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>                      <span class="at">y=</span>data<span class="sc">$</span>log_price, <span class="co"># зависимая переменная</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">alpha =</span> <span class="dv">1</span>, <span class="co"># 1 лассо, 0 ридж</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">lambda =</span> lambdas) <span class="co"># вектор лямбд</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="диагностика" class="level3" data-number="9.1.3">
<h3 data-number="9.1.3" class="anchored" data-anchor-id="диагностика"><span class="header-section-number">9.1.3</span> Диагностика</h3>
<p>В первую очередь мы можем посмотреть общую сводку по оцененным тридцати моделям:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(model_lasso)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:  glmnet(x = X, y = data$log_price, alpha = 1, lambda = lambdas) 

   Df  %Dev  Lambda
1   0  0.00 1.00000
2   0  0.00 0.96550
3   0  0.00 0.93100
4   0  0.00 0.89660
5   0  0.00 0.86210
6   0  0.00 0.82760
7   0  0.00 0.79310
8   0  0.00 0.75860
9   0  0.00 0.72410
10  0  0.00 0.68970
11  0  0.00 0.65520
12  0  0.00 0.62070
13  1  0.71 0.58620
14  1  7.94 0.55170
15  1 14.73 0.51720
16  1 21.09 0.48280
17  1 27.00 0.44830
18  1 32.48 0.41380
19  1 37.52 0.37930
20  1 42.12 0.34480
21  1 46.28 0.31030
22  2 50.33 0.27590
23  2 55.24 0.24140
24  2 59.50 0.20690
25  2 63.10 0.17240
26  2 66.04 0.13790
27  3 68.36 0.10340
28  4 70.63 0.06897
29  5 72.20 0.03448
30 25 73.15 0.00000</code></pre>
</div>
</div>
<p>Эта сводка включает в себя:</p>
<ul>
<li>Df – количество ненулевых коэффициентов;</li>
<li>%Dev – процент объясненной дисперсии;</li>
<li>Lambda – значение параметра регуляризации.</li>
</ul>
<p>Например, мы видим, что сокращая процент объясненной дисперсии с 73% до 68% мы убираем целых 22 коэффициента!</p>
<p>Также мы можем получить коэффициенты модели для одной или нескольких лямбд в диапазоне задаваемой нами ранее последовательности. Первый столбец содержит оценки при <span class="math inline">\(\lambda = 1\)</span> и соответсвует обычному МНК без регуляризации:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(model_lasso, <span class="at">s =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.1</span>, <span class="fl">0.3</span>, <span class="fl">0.5</span>, <span class="fl">0.7</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>27 x 5 sparse Matrix of class "dgCMatrix"
                              s1           s2         s3         s4       s5
(Intercept)          6.688934013  6.884354744 8.30906359 10.0798005 10.87369
(Intercept)          .            .           .           .          .      
log_total_area       1.000871639  0.956754318 0.62494599  0.1935012  .      
discrim_proxy       -0.067431338  .           .           .          .      
Mos_center           0.526321806  0.363336145 0.00375921  .          .      
Akimanka_rajon      -0.003209375  .           .           .          .      
Hamovniki_rajon      0.049532158  .           .           .          .      
Tverskoj_rajon       0.053744571  .           .           .          .      
Taganskij_rajon     -0.257458484  .           .           .          .      
Krasnoselskij_rajon -0.164909968  .           .           .          .      
Mesanskij_rajon     -0.031110726  .           .           .          .      
Zamoskvorece_rajon  -0.018498909  .           .           .          .      
Basmannyj_rajon     -0.201802963  .           .           .          .      
Arbat_rajon          0.022684170  .           .           .          .      
first_floor         -0.061025196  .           .           .          .      
one_room            -0.026247169  .           .           .          .      
two_rooms           -0.024026147  .           .           .          .      
three_rooms          0.001392248  .           .           .          .      
four_and_over_rooms  0.029859360  .           .           .          .      
starii_fond          0.066064231  .           .           .          .      
blochnii            -0.026137209  .           .           .          .      
derevjannii         -0.543010257  .           .           .          .      
kirpichnii          -0.048384083  .           .           .          .      
monolitnii          -0.019660744  .           .           .          .      
panelnii            -0.122118162 -0.001149653 .           .          .      
stalinskii           0.050088144  .           .           .          .      
repair               0.146070488  0.006971480 .           .          .      </code></pre>
</div>
</div>
<p>Есть еще несколько способов взглянуть как выбор гиперпараметра влияет на коэффициенты модели. Построим несколько графиков.</p>
<section id="изменение-коэффициентов-в-зависимости-от-размера-штрафов-lambda" class="level4" data-number="9.1.3.1">
<h4 data-number="9.1.3.1" class="anchored" data-anchor-id="изменение-коэффициентов-в-зависимости-от-размера-штрафов-lambda"><span class="header-section-number">9.1.3.1</span> Изменение коэффициентов в зависимости от размера штрафов (lambda)</h4>
<p>Начнем с графика зависимости величины коэффициентов от логарифма лямбды:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model_lasso, <span class="at">xvar =</span> <span class="st">'lambda'</span>, <span class="at">label =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="high_dimension_regularization_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fl">2.7</span><span class="sc">^</span>(<span class="sc">-</span><span class="fl">2.3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.1018271</code></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fl">2.7</span><span class="sc">^</span>(<span class="sc">-</span><span class="fl">1.3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.2749331</code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fl">2.7</span><span class="sc">^</span>(<span class="sc">-</span><span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.6085806</code></pre>
</div>
</div>
<p>Видим, что при лямбде, равной 0.6, зануляются все коэффициенты модели.</p>
</section>
<section id="изменение-коэффициентов-в-зависимости-от-величины-доли-объясненной-дисперсии" class="level4" data-number="9.1.3.2">
<h4 data-number="9.1.3.2" class="anchored" data-anchor-id="изменение-коэффициентов-в-зависимости-от-величины-доли-объясненной-дисперсии"><span class="header-section-number">9.1.3.2</span> Изменение коэффициентов в зависимости от величины доли объясненной дисперсии</h4>
<p>Теперь построим график зависимости величины коэффициентов от величины объясненной дисперсии:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model_lasso, <span class="at">xvar =</span> <span class="st">'dev'</span>, <span class="at">label =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="high_dimension_regularization_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Снова видим, что снижение объясненной дисперсии с 70% на несколько процентных пунктов позволяет убрать из регрессии более десятка коэффициентов.</p>
</section>
<section id="изменение-коэффициентов-в-зависимости-от-суммарного-штрафа" class="level4" data-number="9.1.3.3">
<h4 data-number="9.1.3.3" class="anchored" data-anchor-id="изменение-коэффициентов-в-зависимости-от-суммарного-штрафа"><span class="header-section-number">9.1.3.3</span> Изменение коэффициентов в зависимости от суммарного штрафа</h4>
<p>Последний график – зависимость величины коэффициентов от размера накладываемого штрафа.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model_lasso, <span class="at">xvar =</span> <span class="st">'norm'</span>, <span class="at">label =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="high_dimension_regularization_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Видим, что большую часть штрафа объясняют второй и четвертый коэффициенты.</p>
</section>
</section>
<section id="кросс-валидация" class="level3" data-number="9.1.4">
<h3 data-number="9.1.4" class="anchored" data-anchor-id="кросс-валидация"><span class="header-section-number">9.1.4</span> Кросс-валидация</h3>
<p>Как было оговорено выше, выбрать величину лямды нам помогает процедура под названием кросс-валидация. Найдем лямбду, которая минимизирует MSE:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>model_cv <span class="ot">&lt;-</span> <span class="fu">cv.glmnet</span>(X, <span class="co"># матрица иксов</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>                      data<span class="sc">$</span>log_price, <span class="co"># зависимая переменная</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">alpha=</span><span class="dv">1</span>, <span class="co"># 1 лассо, 0 ридж</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">type.measure =</span><span class="st">"mse"</span>) <span class="co"># метрика качества</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>График зависимости MSE в кросс-валидации в зависимости от лямд:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model_cv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="high_dimension_regularization_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Функция <code>cv.glmnet</code> расчитывает две лямды.</p>
<p>Первая лямбда минимизирует MSE:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>model_cv<span class="sc">$</span>lambda.min</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.0009607159</code></pre>
</div>
</div>
<p>Мы можем видеть, что эта лямбда получается очень маленькой, то есть оценки регрессии практически дублируют МНК без регуляризации. Поэтому также рассчитывается вторая лямбда (консервативная), которая закладывает чуть больший запас прочности. Она больше минимальной лямбды (которая минимизирует MSE) на одно стандартное отклонение:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>model_cv<span class="sc">$</span>lambda<span class="fl">.1</span>se</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.03002925</code></pre>
</div>
</div>
<p>Мы также можем сравнить коэффициенты в двух моделях с вышеуказанными лямбдами:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(model_cv, <span class="at">s =</span> <span class="st">"lambda.min"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>27 x 1 sparse Matrix of class "dgCMatrix"
                               s1
(Intercept)          6.6370458325
(Intercept)          .           
log_total_area       1.0068449681
discrim_proxy       -0.0657833140
Mos_center           0.5040949860
Akimanka_rajon       0.0139579052
Hamovniki_rajon      0.0648867791
Tverskoj_rajon       0.0739094983
Taganskij_rajon     -0.2241082038
Krasnoselskij_rajon -0.1289100034
Mesanskij_rajon     -0.0004072351
Zamoskvorece_rajon   .           
Basmannyj_rajon     -0.1664366224
Arbat_rajon          0.0419087352
first_floor         -0.0571914907
one_room            -0.0001325229
two_rooms            .           
three_rooms          0.0215989064
four_and_over_rooms  0.0479392737
starii_fond          0.0565052634
blochnii            -0.0179282802
derevjannii         -0.4934208218
kirpichnii          -0.0413662251
monolitnii          -0.0124146216
panelnii            -0.1161728511
stalinskii           0.0488024624
repair               0.1441384544</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(model_cv, <span class="at">s =</span> <span class="st">"lambda.1se"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>27 x 1 sparse Matrix of class "dgCMatrix"
                             s1
(Intercept)          6.55019416
(Intercept)          .         
log_total_area       1.02704039
discrim_proxy       -0.01564148
Mos_center           0.47857861
Akimanka_rajon       .         
Hamovniki_rajon      .         
Tverskoj_rajon       .         
Taganskij_rajon      .         
Krasnoselskij_rajon  .         
Mesanskij_rajon      .         
Zamoskvorece_rajon   .         
Basmannyj_rajon      .         
Arbat_rajon          .         
first_floor          .         
one_room             .         
two_rooms            .         
three_rooms          .         
four_and_over_rooms  .         
starii_fond          .         
blochnii             .         
derevjannii          .         
kirpichnii           .         
monolitnii           .         
panelnii            -0.06304135
stalinskii           .         
repair               0.10603505</code></pre>
</div>
</div>
</section>
</section>
<section id="ridge" class="level2" data-number="9.2">
<h2 data-number="9.2" class="anchored" data-anchor-id="ridge"><span class="header-section-number">9.2</span> Ridge</h2>
<p>С ридж всё аналогично, набор переменных и лямбд будем использовать те же, поэтому шаг с подготовкой можем пропустить.</p>
<section id="оценивание-1" class="level3" data-number="9.2.1">
<h3 data-number="9.2.1" class="anchored" data-anchor-id="оценивание-1"><span class="header-section-number">9.2.1</span> Оценивание</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>model_ridge <span class="ot">&lt;-</span> <span class="fu">glmnet</span>(<span class="at">x=</span>X, <span class="co"># матрица иксов</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>                      <span class="at">y=</span>data<span class="sc">$</span>log_price, <span class="co"># зависимая переменная</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">alpha =</span> <span class="dv">0</span>, <span class="co"># 1 лассо, 0 ридж</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">lambda =</span> lambdas) <span class="co"># вектор лямбд</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="диагностика-1" class="level3" data-number="9.2.2">
<h3 data-number="9.2.2" class="anchored" data-anchor-id="диагностика-1"><span class="header-section-number">9.2.2</span> Диагностика</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(model_ridge)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:  glmnet(x = X, y = data$log_price, alpha = 0, lambda = lambdas) 

   Df  %Dev  Lambda
1  25 63.20 1.00000
2  25 63.55 0.96550
3  25 63.90 0.93100
4  25 64.25 0.89660
5  25 64.60 0.86210
6  25 64.95 0.82760
7  25 65.30 0.79310
8  25 65.66 0.75860
9  25 66.01 0.72410
10 25 66.36 0.68970
11 25 66.71 0.65520
12 25 67.06 0.62070
13 25 67.41 0.58620
14 25 67.76 0.55170
15 25 68.10 0.51720
16 25 68.45 0.48280
17 25 68.79 0.44830
18 25 69.14 0.41380
19 25 69.48 0.37930
20 25 69.82 0.34480
21 25 70.16 0.31030
22 25 70.50 0.27590
23 25 70.84 0.24140
24 25 71.19 0.20690
25 25 71.54 0.17240
26 25 71.90 0.13790
27 25 72.27 0.10340
28 25 72.63 0.06897
29 25 72.97 0.03448
30 25 73.15 0.00000</code></pre>
</div>
</div>
<ul>
<li>Df – количество ненулевых коэффициентов;</li>
<li>%Dev – процент объясненной дисперсии;</li>
<li>Lambda – значение параметра регуляризации.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(model_ridge, <span class="at">s =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.1</span>, <span class="fl">0.3</span>, <span class="fl">0.5</span>, <span class="fl">0.7</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>27 x 5 sparse Matrix of class "dgCMatrix"
                             s1          s2          s3          s4
(Intercept)          6.64622923  7.82150033  8.59638355  8.94662237
(Intercept)          .           .           .           .         
log_total_area       0.99897873  0.72448212  0.53737656  0.45303267
discrim_proxy       -0.06742813 -0.08381652 -0.09346609 -0.09479466
Mos_center           0.27926934  0.28275601  0.26996717  0.25443798
Akimanka_rajon       0.24401916  0.27056845  0.27099289  0.25843118
Hamovniki_rajon      0.29645525  0.27270608  0.24487862  0.22459975
Tverskoj_rajon       0.30072404  0.29333929  0.27584561  0.25871019
Taganskij_rajon     -0.01039935 -0.01933351 -0.01607290 -0.01063353
Krasnoselskij_rajon  0.08210284  0.06971030  0.06511376  0.06345969
Mesanskij_rajon      0.21590629  0.21929606  0.21465652  0.20559180
Zamoskvorece_rajon   0.22849227  0.21641093  0.19970664  0.18628395
Basmannyj_rajon      0.04522337  0.05166245  0.06357240  0.06975185
Arbat_rajon          0.26975954  0.27304921  0.26068747  0.24494209
first_floor         -0.06115603 -0.08482058 -0.09276298 -0.09073422
one_room             0.02345361 -0.12797503 -0.18005839 -0.18634001
two_rooms            0.02646231 -0.03230265 -0.04218364 -0.04271241
three_rooms          0.05268420  0.10293849  0.14283069  0.14877111
four_and_over_rooms  0.08163659  0.19559792  0.25532900  0.25750181
starii_fond          0.06617482  0.10309458  0.14759133  0.16771742
blochnii            -0.02655046 -0.06011294 -0.07320187 -0.07488527
derevjannii         -0.54356480 -0.53405633 -0.46142388 -0.39987828
kirpichnii          -0.04863661 -0.05742225 -0.04577488 -0.03476132
monolitnii          -0.01960235  0.01351756  0.03902709  0.04758936
panelnii            -0.12243000 -0.13729045 -0.13396670 -0.12668462
stalinskii           0.04997978  0.05383198  0.07283667  0.08357672
repair               0.14621993  0.15011033  0.14200161  0.13225801
                              s5
(Intercept)          9.168951934
(Intercept)          .          
log_total_area       0.399735732
discrim_proxy       -0.093328861
Mos_center           0.239758886
Akimanka_rajon       0.244137214
Hamovniki_rajon      0.208128549
Tverskoj_rajon       0.243037619
Taganskij_rajon     -0.006234785
Krasnoselskij_rajon  0.061843445
Mesanskij_rajon      0.195679384
Zamoskvorece_rajon   0.174760220
Basmannyj_rajon      0.072451510
Arbat_rajon          0.229961879
first_floor         -0.086664976
one_room            -0.182340426
two_rooms           -0.041285275
three_rooms          0.146608650
four_and_over_rooms  0.248081512
starii_fond          0.176042856
blochnii            -0.073901381
derevjannii         -0.352313526
kirpichnii          -0.026721380
monolitnii           0.050441717
panelnii            -0.119637562
stalinskii           0.088649856
repair               0.123386550</code></pre>
</div>
</div>
<section id="изменение-коэффициентов-в-зависимости-от-размера-штрафов-lambda-1" class="level4" data-number="9.2.2.1">
<h4 data-number="9.2.2.1" class="anchored" data-anchor-id="изменение-коэффициентов-в-зависимости-от-размера-штрафов-lambda-1"><span class="header-section-number">9.2.2.1</span> Изменение коэффициентов в зависимости от размера штрафов (lambda)</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model_ridge, <span class="at">xvar =</span> <span class="st">'lambda'</span>, <span class="at">label =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="high_dimension_regularization_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="изменение-коэффициентов-в-зависимости-от-величины-доли-объясненной-дисперсии-1" class="level4" data-number="9.2.2.2">
<h4 data-number="9.2.2.2" class="anchored" data-anchor-id="изменение-коэффициентов-в-зависимости-от-величины-доли-объясненной-дисперсии-1"><span class="header-section-number">9.2.2.2</span> Изменение коэффициентов в зависимости от величины доли объясненной дисперсии</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model_ridge, <span class="at">xvar =</span> <span class="st">'dev'</span>, <span class="at">label =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="high_dimension_regularization_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="изменение-коэффициентов-в-зависимости-от-суммарного-штрафа-1" class="level4" data-number="9.2.2.3">
<h4 data-number="9.2.2.3" class="anchored" data-anchor-id="изменение-коэффициентов-в-зависимости-от-суммарного-штрафа-1"><span class="header-section-number">9.2.2.3</span> Изменение коэффициентов в зависимости от суммарного штрафа</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model_ridge, <span class="at">xvar =</span> <span class="st">'norm'</span>, <span class="at">label =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="high_dimension_regularization_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="кросс-валидация-1" class="level3" data-number="9.2.3">
<h3 data-number="9.2.3" class="anchored" data-anchor-id="кросс-валидация-1"><span class="header-section-number">9.2.3</span> Кросс-валидация</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>model_cv <span class="ot">&lt;-</span> <span class="fu">cv.glmnet</span>(X, <span class="co"># матрица иксов</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>                      data<span class="sc">$</span>log_price, <span class="co"># зависимая переменная</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">alpha=</span><span class="dv">1</span>, <span class="co"># 1 лассо, 0 ридж</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">type.measure =</span><span class="st">"mse"</span>) <span class="co"># метрика качества</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>График зависимости MSE в кросс-валидации в зависимости от лямд:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model_cv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="high_dimension_regularization_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Оптимальные лямды:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>model_cv<span class="sc">$</span>lambda.min</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.0009607159</code></pre>
</div>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>model_cv<span class="sc">$</span>lambda<span class="fl">.1</span>se</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.03295706</code></pre>
</div>
</div>
</section>
</section>
<section id="double-lasso-1" class="level2" data-number="9.3">
<h2 data-number="9.3" class="anchored" data-anchor-id="double-lasso-1"><span class="header-section-number">9.3</span> Double LASSO</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(hdm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="способ-1-с-помощью-пакета" class="level3" data-number="9.3.1">
<h3 data-number="9.3.1" class="anchored" data-anchor-id="способ-1-с-помощью-пакета"><span class="header-section-number">9.3.1</span> Способ 1 (с помощью пакета)</h3>
<p>Готовим аргументы:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>formula2 <span class="ot">&lt;-</span> log_price <span class="sc">~</span> log_total_area <span class="sc">+</span> Mos_center <span class="sc">+</span> </span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  Akimanka_rajon <span class="sc">+</span> Hamovniki_rajon <span class="sc">+</span> Tverskoj_rajon <span class="sc">+</span> Taganskij_rajon <span class="sc">+</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  Krasnoselskij_rajon <span class="sc">+</span> Mesanskij_rajon <span class="sc">+</span> Zamoskvorece_rajon <span class="sc">+</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  Basmannyj_rajon <span class="sc">+</span> Arbat_rajon <span class="sc">+</span> first_floor <span class="sc">+</span> one_room <span class="sc">+</span> two_rooms <span class="sc">+</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>  three_rooms <span class="sc">+</span> four_and_over_rooms <span class="sc">+</span> starii_fond <span class="sc">+</span> blochnii <span class="sc">+</span> </span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>  derevjannii <span class="sc">+</span> kirpichnii <span class="sc">+</span> monolitnii <span class="sc">+</span> panelnii <span class="sc">+</span> stalinskii <span class="sc">+</span> repair <span class="co"># формула для регресии без тритмента</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="at">data=</span>data, formula2) <span class="co"># матрица для оценки модели</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> data<span class="sc">$</span>log_price <span class="co"># зависимая переменная</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Оцениваем double lasso модель:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>model_DR <span class="ot">&lt;-</span> <span class="fu">rlassoEffect</span>(X, <span class="co"># матрица иксов</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>                         y, <span class="co"># зависимая переменная</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>                         data<span class="sc">$</span>discrim_proxy, <span class="co"># тритмент</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>                         <span class="at">method =</span> <span class="st">'double selection'</span>) <span class="co"># по умолчанию 'partialling out', но можно и 'double selection'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Таким образом, эффект от дискриминации равен -0.067:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_DR)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Estimates and significance testing of the effect of target variables"
   Estimate. Std. Error t value Pr(&gt;|t|)    
d1  -0.06736    0.00564  -11.94   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p>Можем посмотреть, какие переменные процедура выкинула, а какие оставила:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>model_DR<span class="sc">$</span>selection.index</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        (Intercept)      log_total_area          Mos_center      Akimanka_rajon 
              FALSE                TRUE                TRUE               FALSE 
    Hamovniki_rajon      Tverskoj_rajon     Taganskij_rajon Krasnoselskij_rajon 
               TRUE                TRUE                TRUE                TRUE 
    Mesanskij_rajon  Zamoskvorece_rajon     Basmannyj_rajon         Arbat_rajon 
              FALSE               FALSE                TRUE               FALSE 
        first_floor            one_room           two_rooms         three_rooms 
               TRUE               FALSE               FALSE               FALSE 
four_and_over_rooms         starii_fond            blochnii         derevjannii 
               TRUE               FALSE                TRUE                TRUE 
         kirpichnii          monolitnii            panelnii          stalinskii 
               TRUE                TRUE                TRUE                TRUE 
             repair 
               TRUE </code></pre>
</div>
</div>
</section>
<section id="способ-2-double-selection-руками" class="level3" data-number="9.3.2">
<h3 data-number="9.3.2" class="anchored" data-anchor-id="способ-2-double-selection-руками"><span class="header-section-number">9.3.2</span> Способ 2 (Double selection руками)</h3>
<p><strong>Шаг 1</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>step_1 <span class="ot">&lt;-</span> <span class="fu">cv.glmnet</span>(X, </span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>                    data<span class="sc">$</span>log_price, </span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">alpha=</span><span class="dv">1</span>, </span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">type.measure =</span><span class="st">"mse"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Посмотрим, какие коэффициенты остались после шага 1:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(step_1, <span class="at">s=</span><span class="st">"lambda.1se"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>26 x 1 sparse Matrix of class "dgCMatrix"
                             s1
(Intercept)          6.55075564
(Intercept)          .         
log_total_area       1.02650307
Mos_center           0.47526660
Akimanka_rajon       .         
Hamovniki_rajon      .         
Tverskoj_rajon       .         
Taganskij_rajon      .         
Krasnoselskij_rajon  .         
Mesanskij_rajon      .         
Zamoskvorece_rajon   .         
Basmannyj_rajon      .         
Arbat_rajon          .         
first_floor          .         
one_room             .         
two_rooms            .         
three_rooms          .         
four_and_over_rooms  .         
starii_fond          .         
blochnii             .         
derevjannii          .         
kirpichnii           .         
monolitnii           .         
panelnii            -0.05993709
stalinskii           .         
repair               0.10267275</code></pre>
</div>
</div>
<p>Остались log_total_area, Mos_center, panelnii, repair</p>
<p><strong>Шаг 2</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>step_2 <span class="ot">&lt;-</span> <span class="fu">cv.glmnet</span>(X, </span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>                    data<span class="sc">$</span>discrim_proxy, </span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">alpha=</span><span class="dv">1</span>, </span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">type.measure =</span><span class="st">"mse"</span>,</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>                    <span class="at">family=</span><span class="st">"binomial"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Посмотрим, какие коэффициенты остались после шага 2:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(step_2, <span class="at">s=</span><span class="st">"lambda.1se"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>26 x 1 sparse Matrix of class "dgCMatrix"
                             s1
(Intercept)          2.58136299
(Intercept)          .         
log_total_area      -0.99628560
Mos_center          -0.59645010
Akimanka_rajon       .         
Hamovniki_rajon      .         
Tverskoj_rajon       .         
Taganskij_rajon      .         
Krasnoselskij_rajon  .         
Mesanskij_rajon      .         
Zamoskvorece_rajon   .         
Basmannyj_rajon      .         
Arbat_rajon          .         
first_floor          .         
one_room             .         
two_rooms            0.01441866
three_rooms          .         
four_and_over_rooms  .         
starii_fond          .         
blochnii             .         
derevjannii          .         
kirpichnii           .         
monolitnii           .         
panelnii             0.21044197
stalinskii           .         
repair              -0.15377264</code></pre>
</div>
</div>
<p>Остались log_total_area, Mos_center, panelnii, repair</p>
<p><strong>Шаг 3</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>step_3 <span class="ot">&lt;-</span> <span class="fu">lm</span>(data<span class="sc">$</span>log_price <span class="sc">~</span> discrim_proxy <span class="sc">+</span> log_total_area <span class="sc">+</span> Mos_center <span class="sc">+</span> panelnii <span class="sc">+</span> repair,</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>             <span class="at">data=</span>data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Посмотрим оценку эффекта:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(step_3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = data$log_price ~ discrim_proxy + log_total_area + 
    Mos_center + panelnii + repair, data = data)

Residuals:
    Min      1Q  Median      3Q     Max 
-4.6650 -0.2068  0.0192  0.2200  1.9787 

Coefficients:
                Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)     6.458639   0.023902  270.22   &lt;2e-16 ***
discrim_proxy  -0.067855   0.006365  -10.66   &lt;2e-16 ***
log_total_area  1.048082   0.005808  180.47   &lt;2e-16 ***
Mos_center      0.521361   0.006913   75.42   &lt;2e-16 ***
panelnii       -0.100640   0.005454  -18.45   &lt;2e-16 ***
repair          0.145571   0.004981   29.23   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.3842 on 26035 degrees of freedom
Multiple R-squared:  0.7281,    Adjusted R-squared:  0.728 
F-statistic: 1.394e+04 on 5 and 26035 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p>Таким образом, эффект от дискриминации равен -0.067.</p>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./matching.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Мэтчинг</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./heterogenous_treatment_effects.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Гетерогенные эффекты</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
 Анна Ставнийчук, Прикладная эконометрика, 2023
  </li>  
</ul>
    </div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>



</body></html>