<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.353">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Прикладная эконометрика - 6&nbsp; Мэтчинг</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./high_dimension_regularization.html" rel="next">
<link href="./subclassification.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="site_libs/quarto-diagram/mermaid.min.js"></script>
<script src="site_libs/quarto-diagram/mermaid-init.js"></script>
<link href="site_libs/quarto-diagram/mermaid.css" rel="stylesheet">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./matching.html"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Мэтчинг</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Прикладная эконометрика</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="mailto:annastavnychuk@gmail.com" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-at"></i></a>
    <a href="https://github.com/annastavniychuk" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Предисловие</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./experiments.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Эксперименты</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./multiple_testing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Множественное тестирование гипотез</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./bad_control.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Плохой контроль</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./prestratification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Престратификация</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./subclassification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Взвешивание (subclassification)</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./matching.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Мэтчинг</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./high_dimension_regularization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Регуляризация и большая размерность</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./heterogenous_treatment_effects.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Гетерогенные эффекты</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./regression_discontinuity.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Разрывная регрессия</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./spatial_regression_discontinuity.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Пространственная разрывная регрессия</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./synthetic_control.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Синтетический контроль</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./staggered_adoption.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Ступенчатая разность разностей</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./event_study.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Событийный анализ</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Ссылки</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#теория" id="toc-теория" class="nav-link active" data-scroll-target="#теория"><span class="header-section-number">6.1</span> Теория</a></li>
  <li><a href="#пример" id="toc-пример" class="nav-link" data-scroll-target="#пример"><span class="header-section-number">6.2</span> Пример</a>
  <ul class="collapse">
  <li><a href="#баланс-ковариатов-до-мэтчинга" id="toc-баланс-ковариатов-до-мэтчинга" class="nav-link" data-scroll-target="#баланс-ковариатов-до-мэтчинга"><span class="header-section-number">6.2.1</span> Баланс ковариатов ДО мэтчинга</a></li>
  <li><a href="#оценка-меры-склонности" id="toc-оценка-меры-склонности" class="nav-link" data-scroll-target="#оценка-меры-склонности"><span class="header-section-number">6.2.2</span> Оценка меры склонности</a></li>
  <li><a href="#оценка-ate" id="toc-оценка-ate" class="nav-link" data-scroll-target="#оценка-ate"><span class="header-section-number">6.2.3</span> Оценка ATE</a></li>
  <li><a href="#оценка-att" id="toc-оценка-att" class="nav-link" data-scroll-target="#оценка-att"><span class="header-section-number">6.2.4</span> Оценка ATT</a></li>
  <li><a href="#просто-мэтчинг" id="toc-просто-мэтчинг" class="nav-link" data-scroll-target="#просто-мэтчинг"><span class="header-section-number">6.2.5</span> Просто мэтчинг</a></li>
  <li><a href="#сравнение-мэтчингов" id="toc-сравнение-мэтчингов" class="nav-link" data-scroll-target="#сравнение-мэтчингов"><span class="header-section-number">6.2.6</span> Сравнение мэтчингов</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Мэтчинг</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="теория" class="level2" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="теория"><span class="header-section-number">6.1</span> Теория</h2>
<p>Ранее, когда мы обсуждали рандомизированные эксперименты, где воздействие является случайным (экзогенным), мы говорили, что контрольные переменные <strong>(covariates)</strong> можно не включать, поскольку их пропуск не вызывал смещения. Мы включали их только тогда, когда хотели снизить дисперисю оценки. Схема такой ситуации на рисунке ниже.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<div>
<pre class="mermaid mermaid-js">flowchart LR
  T(T) --&gt; Y(Y)
  X(X) --&gt; Y(Y)
</pre>
</div>
</div>
</div>
</div>
<p>Теперь мы столкнулись с ситуацией, отличной от эксперимента. Наш тритмент больше не является случайным, а контрольные переменные <strong>(confounders)</strong> мы будем использовать для того, чтобы избавиться от смещения.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<div>
<pre class="mermaid mermaid-js">flowchart LR
  T(T) --&gt; Y(Y)
  X(X) --&gt;|1| Y(Y)
  X(X) --&gt;|2| T(T)
</pre>
</div>
</div>
</div>
</div>
<p>На такой икс контролировать обязательно, поскольку в противном случае он создает смещение выборки. К тому же в данной ситуации нельзя просто сравнить средние, нужно как-то убрать лишние стрелочки (см. рисунок выше):</p>
<ol type="1">
<li><p><span class="math inline">\(Y \sim T + X\)</span> – чтобы убрать первую стрелку, нужно построить полную и правильно специфицированную модель Y. Часто это бывает очень сложно. Эквивалентной процедурой будет сначала оценить модель только на X, а потом посмотреть на эффект на остатках.Также это эквивалентно оценке <span class="math inline">\(ATE = \frac{1}{n_T}\sum_{T=1}[Y-m(X)]-\frac{1}{n_C}\sum_{T=0}[Y-m(X)]\)</span>, где <span class="math inline">\(m(X) = \mathbb{E}(Y|X)\)</span>.</p></li>
<li><p><span class="math inline">\(T \sim X\)</span> – гораздо проще построить модель назначения воздействия. Иногда мы знаем точный гайдлайн, по которому формируется группа воздействия, например, разные должностные инструкции или дугие официальные критерии. А иногда мы можем просто догадаться. В любом случае это проще, чем построение общей модели зависимой переменной.</p></li>
</ol>
<p>Предсказанные значения вероятности <span class="math inline">\(\widehat{T}\)</span> называются propensity score (мера склонности). Они используются для расчета весов <span class="math inline">\(w = \frac{T}{e(X)} + \frac{1-T}{1-e(X)}\)</span>, которые входят в оценку эффекта. Используя эти веса строится оценка вида <span class="math inline">\(\widehat{ATE}=\frac{1}{N_T} \sum_{T=1} \frac{1}{e(X)} Y-\frac{1}{N_C} \sum_{T=0} \frac{1}{1-e(X)} Y\)</span>. Аналогично можно оценить обычную регрессию, где в качестве зависимой переменной выступает <span class="math inline">\(wY\)</span>.</p>
<p>Предпосылками к оценке являются:</p>
<ul>
<li><span class="math inline">\(T_i \perp\left(Y(1)_i, Y(0)_i\right) \mid X_i\)</span> – unconfoundedness (CIA, conditional independence assumption). Если взять людей с одинаковыми характеристиками, то факт, что они в такой-то группе, не зависит от потенциальных исходов. Фактически, если мы фиксируем икс, то получаем идеальный эксперимент. Мы говорили, что есть иксы, которые вызывают смещение, потому что “смешивают” внтури нашей выборки разные группы, так вот если мы этот икс фиксируем, “размешивая” наши данные обратно, то внутри каждой группы мы получаем идеальный эксперимент. Невыполнение этой предпосылки ведёт к смещению оценок.</li>
<li><span class="math inline">\(e\left(X_i\right)=E\left(T_i \mid X_i\right) \in(0,1)\)</span> – overlap. Вероятность попадания в тритмент группу зависит от характеристик и ненулевая для всех значений X. Это важно для нас потому, что для propesity score, равному нулю мы не найдем контрольную группу, а наблюдения с propesity score, равным единице совершенно точно имели назначение тритмента, то есть это тоже какие-то странные наблюдения, эффект на которых явно отличается. Невыполнение этой предпосылки ведет к тому, что мы просто физически не сможем посчитать эффект, потому что второе слагаемое в разности средних просто не будет существовать.</li>
</ul>
</section>
<section id="пример" class="level2" data-number="6.2">
<h2 data-number="6.2" class="anchored" data-anchor-id="пример"><span class="header-section-number">6.2</span> Пример</h2>
<p>База данных, впервые использованная в работе LaLonde (1986), представляет собой классический массив данных, используемый в качестве тестового во многих методологических работах, посвященных мэтчингу. Исследуется вопрос о воздействии программ повышения квалификации (переобучения безработных) на доход.</p>
<p>Это подвыборка данных из совокупности, подвергшейся воздействию в рамках программы National Supported Work Demonstration (NSW) и выборки для сопоставления из текущего обследования населения (Current Population Survey, CPS). Эти данные были использованы в исследованиях Lalonde (1986), Dehejia and Wahba (1999).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">'MatchIt'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">'lalonde'</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(lalonde)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     treat age educ   race married nodegree re74 re75       re78
NSW1     1  37   11  black       1        1    0    0  9930.0460
NSW2     1  22    9 hispan       0        1    0    0  3595.8940
NSW3     1  30   12  black       0        0    0    0 24909.4500
NSW4     1  27   11  black       0        1    0    0  7506.1460
NSW5     1  33    8  black       0        1    0    0   289.7899
NSW6     1  22    9  black       0        1    0    0  4056.4940</code></pre>
</div>
</div>
<p>Данные состоят из 614 наблюдений (185 в тритменте, 429 в контроле):</p>
<ul>
<li>treat – назначение тритмента (1 – участвовал в программе, 0 – не участвовал)</li>
<li>age – возраст в годах</li>
<li>educ – количество лет образования</li>
<li>race – этническая принадлежность человека (Black, Hispanic, or White)</li>
<li>married – семейный статус (1 – в браке, 0 – холост).</li>
<li>nodegree – индикатор того, имеет ли человек высшее образование (1 – нет высшего образования, 0 – есть высшее образование)</li>
<li>re74 – доход в 1974 году в долларах США.</li>
<li>re75 – доход в 1975 году в долларах США.</li>
<li>re78 – доход в 1978 году в долларах США.</li>
</ul>
<section id="баланс-ковариатов-до-мэтчинга" class="level3" data-number="6.2.1">
<h3 data-number="6.2.1" class="anchored" data-anchor-id="баланс-ковариатов-до-мэтчинга"><span class="header-section-number">6.2.1</span> Баланс ковариатов ДО мэтчинга</h3>
<p>Основная проблема в случае, когда тритмент является эндогенным, это смещение выборки. С высокой долей вероятности наблюдения в двух группах будут неплохожими друг на друга, то есть предпосылка об экзогенности <span class="math inline">\(T_i \perp Y(1)_i, Y(0)_i, X_i\)</span> не будет выполнена.</p>
<p>Мы можем это проверить на данных, используя тот же инструмент, который мы использовали при проверки качества рандомизации – баланс ковариатов. Фактически это сравнение средних значений контрольных переменных в двух группах. Если воздействие было случайным, то средние в двух группах должны быть примерно равны.</p>
<p>Проверим это для наших данных, используя разные пакеты.</p>
<section id="t-тест-p-value" class="level4" data-number="6.2.1.1">
<h4 data-number="6.2.1.1" class="anchored" data-anchor-id="t-тест-p-value"><span class="header-section-number">6.2.1.1</span> t-тест – p-value</h4>
<p><span class="math inline">\(H_0:\)</span> среднее значение параметра в группах одинаковое, группы не различаются.</p>
<p>Если мы получили достаточно большое значение t-статистики такое, что <span class="math inline">\(p-value &lt; \alpha\)</span>, то мы отклоняем нулевую гипотезу и заключаем, что группы статистически различаются по переменной интереса.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">'tableone'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>table1 <span class="ot">&lt;-</span> <span class="fu">CreateTableOne</span>(<span class="at">vars=</span><span class="fu">c</span>(<span class="st">'age'</span>, <span class="st">'educ'</span>, <span class="st">'race'</span>, <span class="st">'married'</span>, <span class="st">'nodegree'</span>, <span class="st">'re74'</span>, <span class="st">'re75'</span>), </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>                         <span class="at">strata =</span> <span class="st">'treat'</span>, <span class="at">data=</span>lalonde, <span class="at">test=</span><span class="cn">TRUE</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>table1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                      Stratified by treat
                       0                 1                 p      test
  n                        429               185                      
  age (mean (SD))        28.03 (10.79)     25.82 (7.16)     0.011     
  educ (mean (SD))       10.24 (2.86)      10.35 (2.01)     0.633     
  race (%)                                                 &lt;0.001     
     black                  87 (20.3)        156 (84.3)               
     hispan                 61 (14.2)         11 ( 5.9)               
     white                 281 (65.5)         18 ( 9.7)               
  married (mean (SD))     0.51 (0.50)       0.19 (0.39)    &lt;0.001     
  nodegree (mean (SD))    0.60 (0.49)       0.71 (0.46)     0.009     
  re74 (mean (SD))     5619.24 (6788.75) 2095.57 (4886.62) &lt;0.001     
  re75 (mean (SD))     2466.48 (3292.00) 1532.06 (3219.25)  0.001     </code></pre>
</div>
</div>
<p>Видим, что баланс ковариант есть только по переменной education.</p>
</section>
<section id="хи-квадрат-тест-сводит-к-одной-статистике" class="level4" data-number="6.2.1.2">
<h4 data-number="6.2.1.2" class="anchored" data-anchor-id="хи-квадрат-тест-сводит-к-одной-статистике"><span class="header-section-number">6.2.1.2</span> Хи-квадрат тест – сводит к одной статистике</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">'RItools'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">xBalance</span>(treat <span class="sc">~</span> age <span class="sc">+</span> educ <span class="sc">+</span> race <span class="sc">+</span> married <span class="sc">+</span> nodegree <span class="sc">+</span> re74 <span class="sc">+</span> re75, </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>         <span class="at">data=</span>lalonde, <span class="at">report =</span> <span class="st">'chisquare.test'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>---Overall Test---
        chisquare df  p.value
unstrat       238  8 6.17e-47</code></pre>
</div>
</div>
<p>Если статистика &gt;25, то нет баланса. У нас 238, поэтому баланса точно нет.</p>
</section>
<section id="t-тест-std-diff" class="level4" data-number="6.2.1.3">
<h4 data-number="6.2.1.3" class="anchored" data-anchor-id="t-тест-std-diff"><span class="header-section-number">6.2.1.3</span> t-тест – std diff</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>mod1 <span class="ot">&lt;-</span> <span class="fu">matchit</span>(treat <span class="sc">~</span> age <span class="sc">+</span> educ <span class="sc">+</span> race <span class="sc">+</span> married <span class="sc">+</span> nodegree <span class="sc">+</span> re74 <span class="sc">+</span> re75,</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> lalonde, <span class="at">method =</span> <span class="cn">NULL</span>, <span class="at">distance =</span> <span class="st">'glm'</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mod1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
matchit(formula = treat ~ age + educ + race + married + nodegree + 
    re74 + re75, data = lalonde, method = NULL, distance = "glm")

Summary of Balance for All Data:
           Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean
distance          0.5774        0.1822          1.7941     0.9211    0.3774
age              25.8162       28.0303         -0.3094     0.4400    0.0813
educ             10.3459       10.2354          0.0550     0.4959    0.0347
raceblack         0.8432        0.2028          1.7615          .    0.6404
racehispan        0.0595        0.1422         -0.3498          .    0.0827
racewhite         0.0973        0.6550         -1.8819          .    0.5577
married           0.1892        0.5128         -0.8263          .    0.3236
nodegree          0.7081        0.5967          0.2450          .    0.1114
re74           2095.5737     5619.2365         -0.7211     0.5181    0.2248
re75           1532.0553     2466.4844         -0.2903     0.9563    0.1342
           eCDF Max
distance     0.6444
age          0.1577
educ         0.1114
raceblack    0.6404
racehispan   0.0827
racewhite    0.5577
married      0.3236
nodegree     0.1114
re74         0.4470
re75         0.2876

Sample Sizes:
          Control Treated
All           429     185
Matched       429     185
Unmatched       0       0
Discarded       0       0</code></pre>
</div>
</div>
</section>
<section id="t-тест-выдача-в-формате-truefalse" class="level4" data-number="6.2.1.4">
<h4 data-number="6.2.1.4" class="anchored" data-anchor-id="t-тест-выдача-в-формате-truefalse"><span class="header-section-number">6.2.1.4</span> t-тест, выдача в формате true/false</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">'cobalt'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bal.tab</span>(treat <span class="sc">~</span> age <span class="sc">+</span> educ <span class="sc">+</span> race <span class="sc">+</span> married <span class="sc">+</span> nodegree <span class="sc">+</span> re74 <span class="sc">+</span> re75, </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> lalonde, <span class="at">estimand =</span> <span class="st">'ATE'</span>, <span class="at">m.threshold =</span> <span class="fl">0.05</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Balance Measures
               Type Diff.Un      M.Threshold.Un
age         Contin. -0.2419 Not Balanced, &gt;0.05
educ        Contin.  0.0448     Balanced, &lt;0.05
race_black   Binary  0.6404 Not Balanced, &gt;0.05
race_hispan  Binary -0.0827 Not Balanced, &gt;0.05
race_white   Binary -0.5577 Not Balanced, &gt;0.05
married      Binary -0.3236 Not Balanced, &gt;0.05
nodegree     Binary  0.1114 Not Balanced, &gt;0.05
re74        Contin. -0.5958 Not Balanced, &gt;0.05
re75        Contin. -0.2870 Not Balanced, &gt;0.05

Balance tally for mean differences
                    count
Balanced, &lt;0.05         1
Not Balanced, &gt;0.05     8

Variable with the greatest mean difference
   Variable Diff.Un      M.Threshold.Un
 race_black  0.6404 Not Balanced, &gt;0.05

Sample sizes
    Control Treated
All     429     185</code></pre>
</div>
</div>
<p>Баланс есть только по образованию, а вот самый большой дисбаланс по расе – в тритмент группе преобладают темнокожие.</p>
</section>
<section id="dplyr-наше-всё" class="level4" data-number="6.2.1.5">
<h4 data-number="6.2.1.5" class="anchored" data-anchor-id="dplyr-наше-всё"><span class="header-section-number">6.2.1.5</span> dplyr – наше всё</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">'dplyr'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>balance1 <span class="ot">&lt;-</span> lalonde <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(treat) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">avgeduc =</span> <span class="fu">mean</span>(educ))</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>balance1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 2
  treat avgeduc
  &lt;int&gt;   &lt;dbl&gt;
1     0    10.2
2     1    10.3</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>balance2 <span class="ot">&lt;-</span> lalonde <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(treat) <span class="sc">%&gt;%</span> <span class="fu">summarize_all</span>(mean)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>balance2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 9
  treat   age  educ  race married nodegree  re74  re75  re78
  &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1     0  28.0  10.2    NA   0.513    0.597 5619. 2466. 6984.
2     1  25.8  10.3    NA   0.189    0.708 2096. 1532. 6349.</code></pre>
</div>
</div>
</section>
<section id="гистограмы" class="level4" data-number="6.2.1.6">
<h4 data-number="6.2.1.6" class="anchored" data-anchor-id="гистограмы"><span class="header-section-number">6.2.1.6</span> Гистограмы</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>lalonde<span class="sc">$</span>ftreat <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(lalonde<span class="sc">$</span>treat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Во-первых, посмотрим, как изменился доход после участия в программе переобучения:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(lalonde, <span class="fu">aes</span>(<span class="at">x=</span>re74, <span class="at">fill=</span>ftreat, <span class="at">color=</span>ftreat)) <span class="sc">+</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">position=</span><span class="st">"identity"</span>, <span class="at">alpha=</span><span class="fl">0.7</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="matching_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(lalonde, <span class="fu">aes</span>(<span class="at">x=</span>re78, <span class="at">fill=</span>ftreat, <span class="at">color=</span>ftreat)) <span class="sc">+</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">position=</span><span class="st">"identity"</span>, <span class="at">alpha=</span><span class="fl">0.7</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="matching_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Баланс по возрасту отсутствует:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(lalonde, <span class="fu">aes</span>(<span class="at">x=</span>age, <span class="at">fill=</span>ftreat, <span class="at">color=</span>ftreat)) <span class="sc">+</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">position=</span><span class="st">"identity"</span>, <span class="at">alpha=</span><span class="fl">0.7</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="matching_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Баланс по образованию тоже отсутствует:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(lalonde, <span class="fu">aes</span>(<span class="at">x=</span>educ, <span class="at">fill=</span>ftreat, <span class="at">color=</span>ftreat)) <span class="sc">+</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">position=</span><span class="st">"identity"</span>, <span class="at">alpha=</span><span class="fl">0.7</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="matching_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="пакеты-с-красивыми-описательными-статистиками" class="level4" data-number="6.2.1.7">
<h4 data-number="6.2.1.7" class="anchored" data-anchor-id="пакеты-с-красивыми-описательными-статистиками"><span class="header-section-number">6.2.1.7</span> Пакеты с красивыми описательными статистиками</h4>
<section id="пакет-psych" class="level5" data-number="6.2.1.7.1">
<h5 data-number="6.2.1.7.1" class="anchored" data-anchor-id="пакет-psych"><span class="header-section-number">6.2.1.7.1</span> Пакет psych</h5>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">'psych'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>psych<span class="sc">::</span><span class="fu">describeBy</span>(lalonde, lalonde<span class="sc">$</span>treat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
 Descriptive statistics by group 
group: 0
         vars   n    mean      sd  median trimmed     mad min      max    range
treat       1 429    0.00    0.00    0.00    0.00    0.00   0     0.00     0.00
age         2 429   28.03   10.79   25.00   26.72   10.38  16    55.00    39.00
educ        3 429   10.24    2.86   11.00   10.39    1.48   0    18.00    18.00
race*       4 429    2.45    0.81    3.00    2.56    0.00   1     3.00     2.00
married     5 429    0.51    0.50    1.00    0.52    0.00   0     1.00     1.00
nodegree    6 429    0.60    0.49    1.00    0.62    0.00   0     1.00     1.00
re74        7 429 5619.24 6788.75 2547.05 4453.19 3776.25   0 25862.32 25862.32
re75        8 429 2466.48 3292.00 1086.73 1830.87 1611.18   0 18347.23 18347.23
re78        9 429 6984.17 7294.16 4975.50 5968.08 7376.68   0 25564.67 25564.67
ftreat*    10 429    1.00    0.00    1.00    1.00    0.00   1     1.00     0.00
          skew kurtosis     se
treat      NaN      NaN   0.00
age       0.88    -0.34   0.52
educ     -0.68     1.26   0.14
race*    -0.99    -0.75   0.04
married  -0.05    -2.00   0.02
nodegree -0.39    -1.85   0.02
re74      1.22     0.57 327.76
re75      1.77     3.34 158.94
re78      0.94    -0.14 352.17
ftreat*    NaN      NaN   0.00
------------------------------------------------------------ 
group: 1
         vars   n    mean      sd  median trimmed     mad min      max    range
treat       1 185    1.00    0.00    1.00    1.00    0.00   1     1.00     0.00
age         2 185   25.82    7.16   25.00   24.85    5.93  17    48.00    31.00
educ        3 185   10.35    2.01   11.00   10.46    1.48   4    16.00    12.00
race*       4 185    1.25    0.62    1.00    1.07    0.00   1     3.00     2.00
married     5 185    0.19    0.39    0.00    0.11    0.00   0     1.00     1.00
nodegree    6 185    0.71    0.46    1.00    0.76    0.00   0     1.00     1.00
re74        7 185 2095.57 4886.62    0.00  834.42    0.00   0 35040.07 35040.07
re75        8 185 1532.06 3219.25    0.00  790.16    0.00   0 25142.24 25142.24
re78        9 185 6349.14 7867.40 4232.31 4976.95 6274.82   0 60307.93 60307.93
ftreat*    10 185    2.00    0.00    2.00    2.00    0.00   2     2.00     0.00
          skew kurtosis     se
treat      NaN      NaN   0.00
age       1.11     0.81   0.53
educ     -0.72     1.39   0.15
race*     2.20     3.21   0.05
married   1.57     0.48   0.03
nodegree -0.91    -1.18   0.03
re74      3.36    14.20 359.27
re75      3.75    19.03 236.68
re78      2.70    12.28 578.42
ftreat*    NaN      NaN   0.00</code></pre>
</div>
</div>
</section>
<section id="пакет-skimr" class="level5" data-number="6.2.1.7.2">
<h5 data-number="6.2.1.7.2" class="anchored" data-anchor-id="пакет-skimr"><span class="header-section-number">6.2.1.7.2</span> Пакет skimr</h5>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">'skimr'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">skim</span>(lalonde)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<caption>Data summary</caption>
<tbody>
<tr class="odd">
<td style="text-align: left;">Name</td>
<td style="text-align: left;">lalonde</td>
</tr>
<tr class="even">
<td style="text-align: left;">Number of rows</td>
<td style="text-align: left;">614</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Number of columns</td>
<td style="text-align: left;">10</td>
</tr>
<tr class="even">
<td style="text-align: left;">_______________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Column type frequency:</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">factor</td>
<td style="text-align: left;">2</td>
</tr>
<tr class="odd">
<td style="text-align: left;">numeric</td>
<td style="text-align: left;">8</td>
</tr>
<tr class="even">
<td style="text-align: left;">________________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Group variables</td>
<td style="text-align: left;">None</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: factor</strong></p>
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 16%">
<col style="width: 12%">
<col style="width: 16%">
<col style="width: 9%">
<col style="width: 10%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: left;">ordered</th>
<th style="text-align: right;">n_unique</th>
<th style="text-align: left;">top_counts</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">race</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">3</td>
<td style="text-align: left;">whi: 299, bla: 243, his: 72</td>
</tr>
<tr class="even">
<td style="text-align: left;">ftreat</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">0: 429, 1: 185</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: numeric</strong></p>
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 14%">
<col style="width: 10%">
<col style="width: 14%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 3%">
<col style="width: 7%">
<col style="width: 8%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 6%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">sd</th>
<th style="text-align: right;">p0</th>
<th style="text-align: right;">p25</th>
<th style="text-align: right;">p50</th>
<th style="text-align: right;">p75</th>
<th style="text-align: right;">p100</th>
<th style="text-align: left;">hist</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">treat</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.30</td>
<td style="text-align: right;">0.46</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: left;">▇▁▁▁▃</td>
</tr>
<tr class="even">
<td style="text-align: left;">age</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">27.36</td>
<td style="text-align: right;">9.88</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">20.00</td>
<td style="text-align: right;">25.00</td>
<td style="text-align: right;">32.00</td>
<td style="text-align: right;">55.00</td>
<td style="text-align: left;">▇▅▂▂▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">educ</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">10.27</td>
<td style="text-align: right;">2.63</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">9.00</td>
<td style="text-align: right;">11.00</td>
<td style="text-align: right;">12.00</td>
<td style="text-align: right;">18.00</td>
<td style="text-align: left;">▁▂▆▇▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">married</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.42</td>
<td style="text-align: right;">0.49</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: left;">▇▁▁▁▆</td>
</tr>
<tr class="odd">
<td style="text-align: left;">nodegree</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.63</td>
<td style="text-align: right;">0.48</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: left;">▅▁▁▁▇</td>
</tr>
<tr class="even">
<td style="text-align: left;">re74</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">4557.55</td>
<td style="text-align: right;">6477.96</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1042.33</td>
<td style="text-align: right;">7888.50</td>
<td style="text-align: right;">35040.07</td>
<td style="text-align: left;">▇▂▁▁▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">re75</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2184.94</td>
<td style="text-align: right;">3295.68</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">601.55</td>
<td style="text-align: right;">3248.99</td>
<td style="text-align: right;">25142.24</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">re78</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">6792.83</td>
<td style="text-align: right;">7470.73</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">238.28</td>
<td style="text-align: right;">4759.02</td>
<td style="text-align: right;">10893.59</td>
<td style="text-align: right;">60307.93</td>
<td style="text-align: left;">▇▂▁▁▁</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>lalonde <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(treat) <span class="sc">%&gt;%</span> <span class="fu">skim</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<caption>Data summary</caption>
<tbody>
<tr class="odd">
<td style="text-align: left;">Name</td>
<td style="text-align: left;">Piped data</td>
</tr>
<tr class="even">
<td style="text-align: left;">Number of rows</td>
<td style="text-align: left;">614</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Number of columns</td>
<td style="text-align: left;">10</td>
</tr>
<tr class="even">
<td style="text-align: left;">_______________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Column type frequency:</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">factor</td>
<td style="text-align: left;">2</td>
</tr>
<tr class="odd">
<td style="text-align: left;">numeric</td>
<td style="text-align: left;">7</td>
</tr>
<tr class="even">
<td style="text-align: left;">________________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Group variables</td>
<td style="text-align: left;">treat</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: factor</strong></p>
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 15%">
<col style="width: 6%">
<col style="width: 11%">
<col style="width: 15%">
<col style="width: 9%">
<col style="width: 10%">
<col style="width: 30%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">treat</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: left;">ordered</th>
<th style="text-align: right;">n_unique</th>
<th style="text-align: left;">top_counts</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">race</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">3</td>
<td style="text-align: left;">whi: 281, bla: 87, his: 61</td>
</tr>
<tr class="even">
<td style="text-align: left;">race</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">3</td>
<td style="text-align: left;">bla: 156, whi: 18, his: 11</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ftreat</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">0: 429, 1: 0</td>
</tr>
<tr class="even">
<td style="text-align: left;">ftreat</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">1: 185, 0: 0</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: numeric</strong></p>
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 13%">
<col style="width: 5%">
<col style="width: 9%">
<col style="width: 13%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 2%">
<col style="width: 6%">
<col style="width: 7%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 5%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">treat</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">sd</th>
<th style="text-align: right;">p0</th>
<th style="text-align: right;">p25</th>
<th style="text-align: right;">p50</th>
<th style="text-align: right;">p75</th>
<th style="text-align: right;">p100</th>
<th style="text-align: left;">hist</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">age</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">28.03</td>
<td style="text-align: right;">10.79</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">19.00</td>
<td style="text-align: right;">25.00</td>
<td style="text-align: right;">35.00</td>
<td style="text-align: right;">55.00</td>
<td style="text-align: left;">▇▃▂▂▂</td>
</tr>
<tr class="even">
<td style="text-align: left;">age</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">25.82</td>
<td style="text-align: right;">7.16</td>
<td style="text-align: right;">17</td>
<td style="text-align: right;">20.00</td>
<td style="text-align: right;">25.00</td>
<td style="text-align: right;">29.00</td>
<td style="text-align: right;">48.00</td>
<td style="text-align: left;">▇▇▂▁▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">educ</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">10.24</td>
<td style="text-align: right;">2.86</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">9.00</td>
<td style="text-align: right;">11.00</td>
<td style="text-align: right;">12.00</td>
<td style="text-align: right;">18.00</td>
<td style="text-align: left;">▁▂▆▇▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">educ</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">10.35</td>
<td style="text-align: right;">2.01</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">9.00</td>
<td style="text-align: right;">11.00</td>
<td style="text-align: right;">12.00</td>
<td style="text-align: right;">16.00</td>
<td style="text-align: left;">▁▂▇▃▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">married</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.51</td>
<td style="text-align: right;">0.50</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: left;">▇▁▁▁▇</td>
</tr>
<tr class="even">
<td style="text-align: left;">married</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.19</td>
<td style="text-align: right;">0.39</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: left;">▇▁▁▁▂</td>
</tr>
<tr class="odd">
<td style="text-align: left;">nodegree</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.60</td>
<td style="text-align: right;">0.49</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: left;">▆▁▁▁▇</td>
</tr>
<tr class="even">
<td style="text-align: left;">nodegree</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.71</td>
<td style="text-align: right;">0.46</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: left;">▃▁▁▁▇</td>
</tr>
<tr class="odd">
<td style="text-align: left;">re74</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">5619.24</td>
<td style="text-align: right;">6788.75</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">2547.05</td>
<td style="text-align: right;">9277.13</td>
<td style="text-align: right;">25862.32</td>
<td style="text-align: left;">▇▂▂▁▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">re74</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2095.57</td>
<td style="text-align: right;">4886.62</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1291.47</td>
<td style="text-align: right;">35040.07</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">re75</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2466.48</td>
<td style="text-align: right;">3292.00</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1086.73</td>
<td style="text-align: right;">3881.42</td>
<td style="text-align: right;">18347.23</td>
<td style="text-align: left;">▇▂▁▁▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">re75</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1532.06</td>
<td style="text-align: right;">3219.25</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1817.28</td>
<td style="text-align: right;">25142.24</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">re78</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">6984.17</td>
<td style="text-align: right;">7294.16</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">220.18</td>
<td style="text-align: right;">4975.50</td>
<td style="text-align: right;">11688.82</td>
<td style="text-align: right;">25564.67</td>
<td style="text-align: left;">▇▃▂▂▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">re78</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">6349.14</td>
<td style="text-align: right;">7867.40</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">485.23</td>
<td style="text-align: right;">4232.31</td>
<td style="text-align: right;">9643.00</td>
<td style="text-align: right;">60307.93</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="пакет-summarytools" class="level5" data-number="6.2.1.7.3">
<h5 data-number="6.2.1.7.3" class="anchored" data-anchor-id="пакет-summarytools"><span class="header-section-number">6.2.1.7.3</span> Пакет summarytools</h5>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">'summarytools'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dfSummary</span>(lalonde)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Data Frame Summary  
lalonde  
Dimensions: 614 x 10  
Duplicates: 5  

-----------------------------------------------------------------------------------------------------------
No   Variable    Stats / Values                Freqs (% of Valid)    Graph             Valid      Missing  
---- ----------- ----------------------------- --------------------- ----------------- ---------- ---------
1    treat       Min  : 0                      0 : 429 (69.9%)       IIIIIIIIIIIII     614        0        
     [integer]   Mean : 0.3                    1 : 185 (30.1%)       IIIIII            (100.0%)   (0.0%)   
                 Max  : 1                                                                                  

2    age         Mean (sd) : 27.4 (9.9)        40 distinct values    :                 614        0        
     [integer]   min &lt; med &lt; max:                                    : :               (100.0%)   (0.0%)   
                 16 &lt; 25 &lt; 55                                        : : .                                 
                 IQR (CV) : 12 (0.4)                                 : : : . .                             
                                                                     : : : : : : : .                       

3    educ        Mean (sd) : 10.3 (2.6)        19 distinct values              :       614        0        
     [integer]   min &lt; med &lt; max:                                              :       (100.0%)   (0.0%)   
                 0 &lt; 11 &lt; 18                                                 : :                           
                 IQR (CV) : 3 (0.3)                                        : : :                           
                                                                       . . : : : : .                       

4    race        1. black                      243 (39.6%)           IIIIIII           614        0        
     [factor]    2. hispan                      72 (11.7%)           II                (100.0%)   (0.0%)   
                 3. white                      299 (48.7%)           IIIIIIIII                             

5    married     Min  : 0                      0 : 359 (58.5%)       IIIIIIIIIII       614        0        
     [integer]   Mean : 0.4                    1 : 255 (41.5%)       IIIIIIII          (100.0%)   (0.0%)   
                 Max  : 1                                                                                  

6    nodegree    Min  : 0                      0 : 227 (37.0%)       IIIIIII           614        0        
     [integer]   Mean : 0.6                    1 : 387 (63.0%)       IIIIIIIIIIII      (100.0%)   (0.0%)   
                 Max  : 1                                                                                  

7    re74        Mean (sd) : 4557.5 (6478)     358 distinct values   :                 614        0        
     [numeric]   min &lt; med &lt; max:                                    :                 (100.0%)   (0.0%)   
                 0 &lt; 1042.3 &lt; 35040.1                                :                                     
                 IQR (CV) : 7888.5 (1.4)                             :                                     
                                                                     : : . .                               

8    re75        Mean (sd) : 2184.9 (3295.7)   356 distinct values   :                 614        0        
     [numeric]   min &lt; med &lt; max:                                    :                 (100.0%)   (0.0%)   
                 0 &lt; 601.5 &lt; 25142.2                                 :                                     
                 IQR (CV) : 3249 (1.5)                               :                                     
                                                                     : : .                                 

9    re78        Mean (sd) : 6792.8 (7470.7)   457 distinct values   :                 614        0        
     [numeric]   min &lt; med &lt; max:                                    :                 (100.0%)   (0.0%)   
                 0 &lt; 4759 &lt; 60307.9                                  :                                     
                 IQR (CV) : 10655.3 (1.1)                            : :                                   
                                                                     : : : . .                             

10   ftreat      1. 0                          429 (69.9%)           IIIIIIIIIIIII     614        0        
     [factor]    2. 1                          185 (30.1%)           IIIIII            (100.0%)   (0.0%)   
-----------------------------------------------------------------------------------------------------------</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="оценка-меры-склонности" class="level3" data-number="6.2.2">
<h3 data-number="6.2.2" class="anchored" data-anchor-id="оценка-меры-склонности"><span class="header-section-number">6.2.2</span> Оценка меры склонности</h3>
<p>Мы убедились, что баланса в контрольной группе и группе воздействия нет, как и пологается при энлогенном тритменте. Далее будем строить оценку воздействия с помощью мэтчинга.</p>
<section id="вручную" class="level4" data-number="6.2.2.1">
<h4 data-number="6.2.2.1" class="anchored" data-anchor-id="вручную"><span class="header-section-number">6.2.2.1</span> Вручную</h4>
<p>Чтобы построить прогнозное значение вероятности попадания каждого наблюдения в группу воздействия, оценим простейшую логит модель:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>propscore <span class="ot">&lt;-</span> <span class="fu">glm</span>(treat <span class="sc">~</span> age <span class="sc">+</span> educ <span class="sc">+</span> race <span class="sc">+</span> married <span class="sc">+</span> nodegree <span class="sc">+</span> re74 <span class="sc">+</span> re75, </span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> lalonde, <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link=</span><span class="st">'logit'</span>))</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(propscore)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = treat ~ age + educ + race + married + nodegree + 
    re74 + re75, family = binomial(link = "logit"), data = lalonde)

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-1.7645  -0.4736  -0.2862   0.7508   2.7169  

Coefficients:
              Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept) -1.663e+00  9.709e-01  -1.713  0.08668 .  
age          1.578e-02  1.358e-02   1.162  0.24521    
educ         1.613e-01  6.513e-02   2.477  0.01325 *  
racehispan  -2.082e+00  3.672e-01  -5.669 1.44e-08 ***
racewhite   -3.065e+00  2.865e-01 -10.699  &lt; 2e-16 ***
married     -8.321e-01  2.903e-01  -2.866  0.00415 ** 
nodegree     7.073e-01  3.377e-01   2.095  0.03620 *  
re74        -7.178e-05  2.875e-05  -2.497  0.01253 *  
re75         5.345e-05  4.635e-05   1.153  0.24884    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 751.49  on 613  degrees of freedom
Residual deviance: 487.84  on 605  degrees of freedom
AIC: 505.84

Number of Fisher Scoring iterations: 5</code></pre>
</div>
</div>
<p>Посмотрим на первые 10 вероятностей:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>propscore<span class="sc">$</span>fitted.values[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      NSW1       NSW2       NSW3       NSW4       NSW5       NSW6       NSW7 
0.63876993 0.22463424 0.67824388 0.77632408 0.70163874 0.69906990 0.65368426 
      NSW8       NSW9      NSW10 
0.78972311 0.77983825 0.04292461 </code></pre>
</div>
</div>
<p>И на их распределение:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(propscore<span class="sc">$</span>fitted.values)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="matching_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Посчитаем веса по формуле <span class="math inline">\(w = \frac{T}{e(X)} + \frac{1-T}{1-e(X)}\)</span>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>lalonde<span class="sc">$</span>ps_handmade <span class="ot">&lt;-</span> propscore<span class="sc">$</span>fitted.values <span class="co"># добавили в датасет меру склонности для каждого наблюдения</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>lalonde <span class="ot">&lt;-</span> lalonde <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">w_ate =</span> treat<span class="sc">/</span>ps_handmade <span class="sc">+</span> (<span class="dv">1</span><span class="sc">-</span>treat)<span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>ps_handmade)) <span class="co"># посчитаем веса</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="через-пакет-weightit" class="level4" data-number="6.2.2.2">
<h4 data-number="6.2.2.2" class="anchored" data-anchor-id="через-пакет-weightit"><span class="header-section-number">6.2.2.2</span> Через пакет WeightIt</h4>
<p>Аналогичные веса можно получить готовыми из пакета <code>WeightIt</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">'WeightIt'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Однако помимо самих весов пакет представляет в подарок еще и широкую аналитику по весам в вашей выборке:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>propscore1 <span class="ot">&lt;-</span> <span class="fu">weightit</span>(treat <span class="sc">~</span> age <span class="sc">+</span> educ <span class="sc">+</span> race <span class="sc">+</span> married <span class="sc">+</span> nodegree <span class="sc">+</span> re74 <span class="sc">+</span> re75,</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> lalonde, <span class="at">estimand =</span> <span class="st">'ATE'</span>, <span class="at">method =</span> <span class="st">'ps'</span>)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(propscore1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 Summary of weights

- Weight ranges:

           Min                                   Max
treated 1.1721 |---------------------------| 40.0773
control 1.0092 |-|                            4.7432

- Units with the 5 most extreme weights by group:
                                                
              68     116      10     137     124
 treated 13.5451 15.9884 23.2967 23.3891 40.0773
             597     573     381     411     303
 control  4.0301  4.0592  4.2397  4.5231  4.7432

- Weight statistics:

        Coef of Var   MAD Entropy # Zeros
treated       1.478 0.807   0.534       0
control       0.552 0.391   0.118       0

- Effective Sample Sizes:

           Control Treated
Unweighted  429.    185.  
Weighted    329.01   58.33</code></pre>
</div>
</div>
<p>Также сохраним эти веса в свой набор данных:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>lalonde<span class="sc">$</span>w_ate_weightit <span class="ot">&lt;-</span> propscore1<span class="sc">$</span>weights</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>propscore1<span class="sc">$</span>weights[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1]  1.565509  4.451681  1.474396  1.288122  1.425235  1.430472  1.529791
 [8]  1.266267  1.282317 23.296656</code></pre>
</div>
</div>
</section>
</section>
<section id="оценка-ate" class="level3" data-number="6.2.3">
<h3 data-number="6.2.3" class="anchored" data-anchor-id="оценка-ate"><span class="header-section-number">6.2.3</span> Оценка ATE</h3>
<p>Самый простой способ оценить эффект – оценить обычную парную МНК регрессию, где в качестве зависимой переменной выступает <span class="math inline">\(wY\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>mod_ATE <span class="ot">&lt;-</span> <span class="fu">lm</span>(re78 <span class="sc">~</span> treat, <span class="at">data =</span> lalonde, <span class="at">weights =</span> lalonde<span class="sc">$</span>w_ate) <span class="co"># а можно и взять веса из пакета пакет WeightIt</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mod_ATE)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = re78 ~ treat, data = lalonde, weights = lalonde$w_ate)

Weighted Residuals:
   Min     1Q Median     3Q    Max 
-42083  -6606  -2284   4979  77674 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)   6422.8      397.4  16.161   &lt;2e-16 ***
treat          224.7      577.7   0.389    0.697    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 9864 on 612 degrees of freedom
Multiple R-squared:  0.0002471, Adjusted R-squared:  -0.001386 
F-statistic: 0.1513 on 1 and 612 DF,  p-value: 0.6975</code></pre>
</div>
</div>
</section>
<section id="оценка-att" class="level3" data-number="6.2.4">
<h3 data-number="6.2.4" class="anchored" data-anchor-id="оценка-att"><span class="header-section-number">6.2.4</span> Оценка ATT</h3>
<p>Для оценки воздействия на воздействованных понадобятся иные веса.</p>
<section id="веса-вручную" class="level4" data-number="6.2.4.1">
<h4 data-number="6.2.4.1" class="anchored" data-anchor-id="веса-вручную"><span class="header-section-number">6.2.4.1</span> Веса вручную</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>lalonde <span class="ot">&lt;-</span> lalonde <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">w_att =</span> treat <span class="sc">+</span> (<span class="dv">1</span><span class="sc">-</span>treat)<span class="sc">*</span>ps_handmade<span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>ps_handmade)) <span class="co"># посчитаем веса</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="веса-через-пакет-weightit" class="level4" data-number="6.2.4.2">
<h4 data-number="6.2.4.2" class="anchored" data-anchor-id="веса-через-пакет-weightit"><span class="header-section-number">6.2.4.2</span> Веса через пакет WeightIt</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>propscore2 <span class="ot">&lt;-</span> <span class="fu">weightit</span>(treat <span class="sc">~</span> age <span class="sc">+</span> educ <span class="sc">+</span> race <span class="sc">+</span> married <span class="sc">+</span> nodegree <span class="sc">+</span> re74 <span class="sc">+</span> re75,</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> lalonde, <span class="at">estimand =</span> <span class="st">'ATT'</span>, <span class="at">method =</span> <span class="st">'ps'</span>)</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(propscore2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 Summary of weights

- Weight ranges:

           Min                                  Max
treated 1.0000         ||                    1.0000
control 0.0092 |---------------------------| 3.7432

- Units with the 5 most extreme weights by group:
                                           
              5      4      3      2      1
 treated      1      1      1      1      1
            597    573    381    411    303
 control 3.0301 3.0592 3.2397 3.5231 3.7432

- Weight statistics:

        Coef of Var   MAD Entropy # Zeros
treated       0.000 0.000  -0.000       0
control       1.818 1.289   1.098       0

- Effective Sample Sizes:

           Control Treated
Unweighted  429.       185
Weighted     99.82     185</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>propscore2<span class="sc">$</span>weights[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 1 1 1 1 1 1 1 1 1 1</code></pre>
</div>
</div>
</section>
<section id="сам-эффект" class="level4" data-number="6.2.4.3">
<h4 data-number="6.2.4.3" class="anchored" data-anchor-id="сам-эффект"><span class="header-section-number">6.2.4.3</span> Сам эффект</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>mod_ATT <span class="ot">&lt;-</span> <span class="fu">lm</span>(re78 <span class="sc">~</span> treat, <span class="at">data =</span> lalonde, <span class="at">weights =</span> lalonde<span class="sc">$</span>w_att) <span class="co"># а можно и взять веса из пакета пакет WeightIt</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mod_ATT)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = re78 ~ treat, data = lalonde, weights = lalonde$w_att)

Weighted Residuals:
   Min     1Q Median     3Q    Max 
 -9182  -1938   -326   1792  53959 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)   5135.1      401.2  12.799   &lt;2e-16 ***
treat         1214.1      568.9   2.134   0.0332 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 5486 on 612 degrees of freedom
Multiple R-squared:  0.007387,  Adjusted R-squared:  0.005765 
F-statistic: 4.554 on 1 and 612 DF,  p-value: 0.03324</code></pre>
</div>
</div>
</section>
</section>
<section id="просто-мэтчинг" class="level3" data-number="6.2.5">
<h3 data-number="6.2.5" class="anchored" data-anchor-id="просто-мэтчинг"><span class="header-section-number">6.2.5</span> Просто мэтчинг</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">'MatchIt'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="точный-мэтчинг" class="level4" data-number="6.2.5.1">
<h4 data-number="6.2.5.1" class="anchored" data-anchor-id="точный-мэтчинг"><span class="header-section-number">6.2.5.1</span> Точный мэтчинг</h4>
<p>Сначала подбираем мэтчи и считаем веса:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>model_0 <span class="ot">&lt;-</span> <span class="fu">matchit</span>(treat <span class="sc">~</span> age <span class="sc">+</span> educ <span class="sc">+</span> race <span class="sc">+</span> married <span class="sc">+</span> nodegree <span class="sc">+</span> re74 <span class="sc">+</span> re75, </span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> lalonde, <span class="at">method =</span> <span class="st">"exact"</span>, <span class="at">estimand =</span> <span class="st">'ATE'</span>)</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
matchit(formula = treat ~ age + educ + race + married + nodegree + 
    re74 + re75, data = lalonde, method = "exact", estimand = "ATE")

Summary of Balance for All Data:
           Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean
age              25.8162       28.0303         -0.2419     0.4400    0.0813
educ             10.3459       10.2354          0.0448     0.4959    0.0347
raceblack         0.8432        0.2028          1.6708          .    0.6404
racehispan        0.0595        0.1422         -0.2774          .    0.0827
racewhite         0.0973        0.6550         -1.4080          .    0.5577
married           0.1892        0.5128         -0.7208          .    0.3236
nodegree          0.7081        0.5967          0.2355          .    0.1114
re74           2095.5737     5619.2365         -0.5958     0.5181    0.2248
re75           1532.0553     2466.4844         -0.2870     0.9563    0.1342
           eCDF Max
age          0.1577
educ         0.1114
raceblack    0.6404
racehispan   0.0827
racewhite    0.5577
married      0.3236
nodegree     0.1114
re74         0.4470
re75         0.2876

Summary of Balance for Matched Data:
           Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean
age                18.12         18.12               0     0.9927         0
educ               10.32         10.32               0     0.9927         0
raceblack           1.00          1.00               0          .         0
racehispan          0.00          0.00               0          .         0
racewhite           0.00          0.00               0          .         0
married             0.00          0.00               0          .         0
nodegree            0.80          0.80               0          .         0
re74                0.00          0.00               0          .         0
re75                0.00          0.00               0          .         0
           eCDF Max Std. Pair Dist.
age               0               0
educ              0               0
raceblack         0               0
racehispan        0               0
racewhite         0               0
married           0               0
nodegree          0               0
re74              0               0
re75              0               0

Sample Sizes:
              Control Treated
All            429.    185.  
Matched (ESS)   11.26   12.18
Matched         12.     13.  
Unmatched      417.    172.  
Discarded        0.      0.  </code></pre>
</div>
</div>
<p>Видим, что с помощью точного мэтчинга подобралось лишь 12 пар.</p>
<p>Затем проверяем баланс при данном типе мэтчинга. Белые точки соответсвуют балансу до мэтчинга, черные – после. Видим, что до мэтчинга баланс был выполнен лишь для образования, а после мэтчинга для всех переменных. Однако за этим мы расплатились малым количеством пар, а малое количество наблюдений при усреднении ведёт к высокой дисперсии, то есть из-за широкого доверительного интервала мы можем не заметить даже реально существующий эффект.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">summary</span>(model_0))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="matching_files/figure-html/unnamed-chunk-41-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model_0, <span class="at">type =</span> <span class="st">"qq"</span>, <span class="at">interactive =</span> <span class="cn">FALSE</span>, <span class="at">wich.xs =</span> <span class="fu">c</span>(<span class="st">'age'</span>, <span class="st">'married'</span>, <span class="st">'re75'</span>, <span class="st">'re74'</span>, <span class="st">'educ'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="matching_files/figure-html/unnamed-chunk-42-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output-display">
<p><img src="matching_files/figure-html/unnamed-chunk-42-2.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output-display">
<p><img src="matching_files/figure-html/unnamed-chunk-42-3.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Считаем эффект и видим, что он незначим.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>model_0_t <span class="ot">&lt;-</span> <span class="fu">lm</span>(re78 <span class="sc">~</span> treat, <span class="at">data =</span> lalonde, <span class="at">weights =</span> model_0<span class="sc">$</span>weights) </span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_0_t)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = re78 ~ treat, data = lalonde, weights = model_0$weights)

Weighted Residuals:
   Min     1Q Median     3Q    Max 
 -7598      0      0      0  12131 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)   
(Intercept)     6331       1875   3.376   0.0026 **
treat          -1132       2600  -0.435   0.6675   
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 6496 on 23 degrees of freedom
Multiple R-squared:  0.008168,  Adjusted R-squared:  -0.03495 
F-statistic: 0.1894 on 1 and 23 DF,  p-value: 0.6675</code></pre>
</div>
</div>
</section>
<section id="метод-ближайшего-соседа-с-расстоянием-по-мере-склонности" class="level4" data-number="6.2.5.2">
<h4 data-number="6.2.5.2" class="anchored" data-anchor-id="метод-ближайшего-соседа-с-расстоянием-по-мере-склонности"><span class="header-section-number">6.2.5.2</span> Метод ближайшего соседа с расстоянием по мере склонности</h4>
<p>По умолчанию, для мэтчинга по методу ближайшего соседа функция <code>matchit()</code> использует логистическую регрессию для оценки индивидуальных вероятностей попадания в группу воздействия. Чтобы изменить метрику, следует применить аргумент distance.</p>
<p>Сопоставление ближайших соседей также известно как жадное сопоставление. Оно включает просмотр тритмент наблюдений и выбор ближайшего наблюдения из контрольной группы для сопоставления. Подход является жадным в том смысле, что каждое сопоставление происходит безотносительно к тому, как будут или были сопоставлены другие пары, и поэтому не направлено на оптимизацию какого-либо критерия общего критерия, кроме минимизации расстояния на конкретном шаге. То есть на каждом отдельном шаге это будет оптимум, однако сумма попарных расстояний может не быть мимнимальной.</p>
<p>Сопоставление ближайших соседей также требудет указания метрики расстояния. По умолчаниюиспользуется разница в мере склонности. Еще одно популярное расстояние — расстояние Махаланобиса. Пакет при подборе пар по умолчанию начинает с наблюдений с наибольшей мерой склоннсти и дальше действует по убыванию. Это позволит первыми сопоставить те наблюдения, которым будет труднее всего найти пару. Однако возможны и другие упорядочивания (случайные, с возвращениями и т.д.)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>model_1 <span class="ot">&lt;-</span> <span class="fu">matchit</span>(treat <span class="sc">~</span> age <span class="sc">+</span> educ <span class="sc">+</span> race <span class="sc">+</span> married <span class="sc">+</span> nodegree <span class="sc">+</span> re74 <span class="sc">+</span> re75, </span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> lalonde, <span class="at">method =</span> <span class="st">'nearest'</span>, <span class="at">estimand =</span> <span class="st">'ATT'</span>)</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
matchit(formula = treat ~ age + educ + race + married + nodegree + 
    re74 + re75, data = lalonde, method = "nearest", estimand = "ATT")

Summary of Balance for All Data:
           Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean
distance          0.5774        0.1822          1.7941     0.9211    0.3774
age              25.8162       28.0303         -0.3094     0.4400    0.0813
educ             10.3459       10.2354          0.0550     0.4959    0.0347
raceblack         0.8432        0.2028          1.7615          .    0.6404
racehispan        0.0595        0.1422         -0.3498          .    0.0827
racewhite         0.0973        0.6550         -1.8819          .    0.5577
married           0.1892        0.5128         -0.8263          .    0.3236
nodegree          0.7081        0.5967          0.2450          .    0.1114
re74           2095.5737     5619.2365         -0.7211     0.5181    0.2248
re75           1532.0553     2466.4844         -0.2903     0.9563    0.1342
           eCDF Max
distance     0.6444
age          0.1577
educ         0.1114
raceblack    0.6404
racehispan   0.0827
racewhite    0.5577
married      0.3236
nodegree     0.1114
re74         0.4470
re75         0.2876

Summary of Balance for Matched Data:
           Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean
distance          0.5774        0.3629          0.9739     0.7566    0.1321
age              25.8162       25.3027          0.0718     0.4568    0.0847
educ             10.3459       10.6054         -0.1290     0.5721    0.0239
raceblack         0.8432        0.4703          1.0259          .    0.3730
racehispan        0.0595        0.2162         -0.6629          .    0.1568
racewhite         0.0973        0.3135         -0.7296          .    0.2162
married           0.1892        0.2108         -0.0552          .    0.0216
nodegree          0.7081        0.6378          0.1546          .    0.0703
re74           2095.5737     2342.1076         -0.0505     1.3289    0.0469
re75           1532.0553     1614.7451         -0.0257     1.4956    0.0452
           eCDF Max Std. Pair Dist.
distance     0.4216          0.9740
age          0.2541          1.3938
educ         0.0757          1.2474
raceblack    0.3730          1.0259
racehispan   0.1568          1.0743
racewhite    0.2162          0.8390
married      0.0216          0.8281
nodegree     0.0703          1.0106
re74         0.2757          0.7965
re75         0.2054          0.7381

Sample Sizes:
          Control Treated
All           429     185
Matched       185     185
Unmatched     244       0
Discarded       0       0</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model_1, <span class="at">type =</span> <span class="st">'jitter'</span>, <span class="at">interactive =</span> <span class="cn">FALSE</span>) <span class="co"># расположение наблюдений по propscore</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="matching_files/figure-html/unnamed-chunk-45-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">summary</span>(model_1))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="matching_files/figure-html/unnamed-chunk-46-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model_1, <span class="at">type =</span> <span class="st">"qq"</span>, <span class="at">interactive =</span> <span class="cn">FALSE</span>, <span class="at">wich.xs =</span> <span class="fu">c</span>(<span class="st">'age'</span>, <span class="st">'married'</span>, <span class="st">'re75'</span>, <span class="st">'re74'</span>, <span class="st">'educ'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="matching_files/figure-html/unnamed-chunk-47-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output-display">
<p><img src="matching_files/figure-html/unnamed-chunk-47-2.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output-display">
<p><img src="matching_files/figure-html/unnamed-chunk-47-3.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>model_1_t <span class="ot">&lt;-</span> <span class="fu">lm</span>(re78 <span class="sc">~</span> treat, <span class="at">data =</span> lalonde, <span class="at">weights =</span> model_1<span class="sc">$</span>weights) </span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_1_t)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = re78 ~ treat, data = lalonde, weights = model_1$weights)

Weighted Residuals:
   Min     1Q Median     3Q    Max 
 -6349  -3734      0      0  53959 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)   5454.8      516.4  10.563   &lt;2e-16 ***
treat          894.4      730.3   1.225    0.221    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 7024 on 368 degrees of freedom
Multiple R-squared:  0.004059,  Adjusted R-squared:  0.001353 
F-statistic:   1.5 on 1 and 368 DF,  p-value: 0.2215</code></pre>
</div>
</div>
</section>
<section id="метод-ближайшего-соседа-c-расстоянием-махаланобиса" class="level4" data-number="6.2.5.3">
<h4 data-number="6.2.5.3" class="anchored" data-anchor-id="метод-ближайшего-соседа-c-расстоянием-махаланобиса"><span class="header-section-number">6.2.5.3</span> Метод ближайшего соседа c расстоянием Махаланобиса</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>model_2 <span class="ot">&lt;-</span> <span class="fu">matchit</span>(treat <span class="sc">~</span> age <span class="sc">+</span> educ <span class="sc">+</span> race <span class="sc">+</span> married <span class="sc">+</span> nodegree <span class="sc">+</span> re74 <span class="sc">+</span> re75, </span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> lalonde, <span class="at">method =</span> <span class="st">'nearest'</span>, <span class="at">distance =</span> <span class="st">'mahalanobis'</span>, <span class="at">estimand =</span> <span class="st">'ATT'</span>)</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
matchit(formula = treat ~ age + educ + race + married + nodegree + 
    re74 + re75, data = lalonde, method = "nearest", distance = "mahalanobis", 
    estimand = "ATT")

Summary of Balance for All Data:
           Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean
age              25.8162       28.0303         -0.3094     0.4400    0.0813
educ             10.3459       10.2354          0.0550     0.4959    0.0347
raceblack         0.8432        0.2028          1.7615          .    0.6404
racehispan        0.0595        0.1422         -0.3498          .    0.0827
racewhite         0.0973        0.6550         -1.8819          .    0.5577
married           0.1892        0.5128         -0.8263          .    0.3236
nodegree          0.7081        0.5967          0.2450          .    0.1114
re74           2095.5737     5619.2365         -0.7211     0.5181    0.2248
re75           1532.0553     2466.4844         -0.2903     0.9563    0.1342
           eCDF Max
age          0.1577
educ         0.1114
raceblack    0.6404
racehispan   0.0827
racewhite    0.5577
married      0.3236
nodegree     0.1114
re74         0.4470
re75         0.2876

Summary of Balance for Matched Data:
           Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean
age              25.8162       24.9189          0.1254     0.5333    0.0692
educ             10.3459       10.4378         -0.0457     0.8306    0.0111
raceblack         0.8432        0.4649          1.0407          .    0.3784
racehispan        0.0595        0.0595          0.0000          .    0.0000
racewhite         0.0973        0.4757         -1.2767          .    0.3784
married           0.1892        0.2486         -0.1518          .    0.0595
nodegree          0.7081        0.6595          0.1070          .    0.0486
re74           2095.5737     3308.2167         -0.2482     0.8710    0.1016
re75           1532.0553     1960.6355         -0.1331     1.0081    0.0662
           eCDF Max Std. Pair Dist.
age          0.2324          0.6210
educ         0.0486          0.2930
raceblack    0.3784          1.0407
racehispan   0.0000          0.0000
racewhite    0.3784          1.2767
married      0.0595          0.1794
nodegree     0.0486          0.1070
re74         0.3405          0.4552
re75         0.2216          0.4123

Sample Sizes:
          Control Treated
All           429     185
Matched       185     185
Unmatched     244       0
Discarded       0       0</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">summary</span>(model_2))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="matching_files/figure-html/unnamed-chunk-50-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Мы также можем построить стандартизированные средние различия на графике Лава</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co">#eCDF plot</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model_2, <span class="at">type =</span> <span class="st">"ecdf"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="matching_files/figure-html/unnamed-chunk-51-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output-display">
<p><img src="matching_files/figure-html/unnamed-chunk-51-2.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output-display">
<p><img src="matching_files/figure-html/unnamed-chunk-51-3.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>По оси X отображаются значения ковариат, а по оси Y отображается доля выборки, равная или меньшая этого значения ковариаты. Идеально перекрывающиеся линии указывают на хороший баланс. Черная линия соответствует группе воздействия, а серая линия — контрольной группе.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co">#eCDF plot</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model_2, <span class="at">type =</span> <span class="st">"density"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="matching_files/figure-html/unnamed-chunk-52-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output-display">
<p><img src="matching_files/figure-html/unnamed-chunk-52-2.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output-display">
<p><img src="matching_files/figure-html/unnamed-chunk-52-3.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model_2, <span class="at">type =</span> <span class="st">"qq"</span>, <span class="at">interactive =</span> <span class="cn">FALSE</span>, <span class="at">wich.xs =</span> <span class="fu">c</span>(<span class="st">'age'</span>, <span class="st">'married'</span>, <span class="st">'re75'</span>, <span class="st">'re74'</span>, <span class="st">'educ'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="matching_files/figure-html/unnamed-chunk-53-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output-display">
<p><img src="matching_files/figure-html/unnamed-chunk-53-2.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output-display">
<p><img src="matching_files/figure-html/unnamed-chunk-53-3.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>model_2_t <span class="ot">&lt;-</span> <span class="fu">lm</span>(re78 <span class="sc">~</span> treat, <span class="at">data =</span> lalonde, <span class="at">weights =</span> model_2<span class="sc">$</span>weights) </span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_2_t)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = re78 ~ treat, data = lalonde, weights = model_2$weights)

Weighted Residuals:
   Min     1Q Median     3Q    Max 
 -6349  -3591      0      0  53959 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)   5832.5      528.0  11.047   &lt;2e-16 ***
treat          516.6      746.7   0.692    0.489    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 7181 on 368 degrees of freedom
Multiple R-squared:  0.001299,  Adjusted R-squared:  -0.001415 
F-statistic: 0.4787 on 1 and 368 DF,  p-value: 0.4894</code></pre>
</div>
</div>
</section>
<section id="комбинация-метода-ближайшего-соседа-и-точного-мэтчинга" class="level4" data-number="6.2.5.4">
<h4 data-number="6.2.5.4" class="anchored" data-anchor-id="комбинация-метода-ближайшего-соседа-и-точного-мэтчинга"><span class="header-section-number">6.2.5.4</span> Комбинация метода “ближайшего соседа” и точного мэтчинга</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>model_3 <span class="ot">&lt;-</span> <span class="fu">matchit</span>(treat <span class="sc">~</span> age <span class="sc">+</span> educ <span class="sc">+</span> race <span class="sc">+</span> married <span class="sc">+</span> nodegree <span class="sc">+</span> re74 <span class="sc">+</span> re75, </span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> lalonde, <span class="at">method =</span> <span class="st">"nearest"</span>, <span class="at">distance =</span> <span class="st">'mahalanobis'</span>,</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">exact =</span> <span class="fu">c</span> (<span class="st">"educ"</span>,<span class="st">"race"</span>, <span class="st">"married"</span>,<span class="st">"nodegree"</span>), <span class="at">estimand =</span> <span class="st">'ATT'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Fewer control units than treated units in some `exact` strata; not all
treated units will get a match.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
matchit(formula = treat ~ age + educ + race + married + nodegree + 
    re74 + re75, data = lalonde, method = "nearest", distance = "mahalanobis", 
    estimand = "ATT", exact = c("educ", "race", "married", "nodegree"))

Summary of Balance for All Data:
           Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean
age              25.8162       28.0303         -0.3094     0.4400    0.0813
educ             10.3459       10.2354          0.0550     0.4959    0.0347
raceblack         0.8432        0.2028          1.7615          .    0.6404
racehispan        0.0595        0.1422         -0.3498          .    0.0827
racewhite         0.0973        0.6550         -1.8819          .    0.5577
married           0.1892        0.5128         -0.8263          .    0.3236
nodegree          0.7081        0.5967          0.2450          .    0.1114
re74           2095.5737     5619.2365         -0.7211     0.5181    0.2248
re75           1532.0553     2466.4844         -0.2903     0.9563    0.1342
           eCDF Max
age          0.1577
educ         0.1114
raceblack    0.6404
racehispan   0.0827
racewhite    0.5577
married      0.3236
nodegree     0.1114
re74         0.4470
re75         0.2876

Summary of Balance for Matched Data:
           Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean
age              25.9020       25.2157          0.0959     0.5407    0.0696
educ             10.2843       10.2843          0.0000     1.0000    0.0000
raceblack         0.7157        0.7157          0.0000          .    0.0000
racehispan        0.1078        0.1078          0.0000          .    0.0000
racewhite         0.1765        0.1765          0.0000          .    0.0000
married           0.2157        0.2157          0.0000          .    0.0000
nodegree          0.6667        0.6667          0.0000          .    0.0000
re74           1090.1290     2618.1375         -0.3127     0.5914    0.1337
re75           1017.1332     1497.0957         -0.1491     1.0732    0.0993
           eCDF Max Std. Pair Dist.
age          0.2549          0.7701
educ         0.0000          0.0000
raceblack    0.0000          0.0000
racehispan   0.0000          0.0000
racewhite    0.0000          0.0000
married      0.0000          0.0000
nodegree     0.0000          0.0000
re74         0.4608          0.4536
re75         0.3235          0.4384

Sample Sizes:
          Control Treated
All           429     185
Matched       102     102
Unmatched     327      83
Discarded       0       0</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">summary</span>(model_3))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="matching_files/figure-html/unnamed-chunk-56-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model_3, <span class="at">type =</span> <span class="st">"qq"</span>, <span class="at">interactive =</span> <span class="cn">FALSE</span>, <span class="at">wich.xs =</span> <span class="fu">c</span>(<span class="st">'age'</span>, <span class="st">'married'</span>, <span class="st">'re75'</span>, <span class="st">'re74'</span>, <span class="st">'educ'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="matching_files/figure-html/unnamed-chunk-57-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output-display">
<p><img src="matching_files/figure-html/unnamed-chunk-57-2.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output-display">
<p><img src="matching_files/figure-html/unnamed-chunk-57-3.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>model_3_t <span class="ot">&lt;-</span> <span class="fu">lm</span>(re78 <span class="sc">~</span> treat, <span class="at">data =</span> lalonde, <span class="at">weights =</span> model_3<span class="sc">$</span>weights) </span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_3_t)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = re78 ~ treat, data = lalonde, weights = model_3$weights)

Weighted Residuals:
   Min     1Q Median     3Q    Max 
 -5976      0      0      0  20842 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)   5618.1      617.6   9.097   &lt;2e-16 ***
treat          357.5      873.4   0.409    0.683    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 6237 on 202 degrees of freedom
Multiple R-squared:  0.0008287, Adjusted R-squared:  -0.004118 
F-statistic: 0.1675 on 1 and 202 DF,  p-value: 0.6828</code></pre>
</div>
</div>
</section>
<section id="метод-минимизации-суммы-попарных-расстояний" class="level4" data-number="6.2.5.5">
<h4 data-number="6.2.5.5" class="anchored" data-anchor-id="метод-минимизации-суммы-попарных-расстояний"><span class="header-section-number">6.2.5.5</span> Метод минимизации суммы попарных расстояний</h4>
<p>Оптимальный подбор пар очень похож на сопоставление ближайших соседей, поскольку пытается соединить каждое наблюдение из тритмента с одним или несколькми наблюденями из контрольной группы. Однако в отличие от сопоставления методом ближайших соседей он является «оптимальным», а не жадным; он оптимален в том смысле, что пытается выбрать совпадения, которые в совокупности оптимизируют общую сумму абсолютных попарных расстояний.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">'optmatch'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>model_4 <span class="ot">&lt;-</span> <span class="fu">matchit</span>(treat <span class="sc">~</span> age <span class="sc">+</span> educ <span class="sc">+</span> race <span class="sc">+</span> married <span class="sc">+</span> nodegree <span class="sc">+</span> re74 <span class="sc">+</span> re75, </span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> lalonde, <span class="at">method =</span> <span class="st">'optimal'</span>, <span class="at">estimand =</span> <span class="st">'ATT'</span>)</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
matchit(formula = treat ~ age + educ + race + married + nodegree + 
    re74 + re75, data = lalonde, method = "optimal", estimand = "ATT")

Summary of Balance for All Data:
           Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean
distance          0.5774        0.1822          1.7941     0.9211    0.3774
age              25.8162       28.0303         -0.3094     0.4400    0.0813
educ             10.3459       10.2354          0.0550     0.4959    0.0347
raceblack         0.8432        0.2028          1.7615          .    0.6404
racehispan        0.0595        0.1422         -0.3498          .    0.0827
racewhite         0.0973        0.6550         -1.8819          .    0.5577
married           0.1892        0.5128         -0.8263          .    0.3236
nodegree          0.7081        0.5967          0.2450          .    0.1114
re74           2095.5737     5619.2365         -0.7211     0.5181    0.2248
re75           1532.0553     2466.4844         -0.2903     0.9563    0.1342
           eCDF Max
distance     0.6444
age          0.1577
educ         0.1114
raceblack    0.6404
racehispan   0.0827
racewhite    0.5577
married      0.3236
nodegree     0.1114
re74         0.4470
re75         0.2876

Summary of Balance for Matched Data:
           Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean
distance          0.5774        0.3629          0.9739     0.7566    0.1321
age              25.8162       25.3027          0.0718     0.4568    0.0847
educ             10.3459       10.6054         -0.1290     0.5721    0.0239
raceblack         0.8432        0.4703          1.0259          .    0.3730
racehispan        0.0595        0.2162         -0.6629          .    0.1568
racewhite         0.0973        0.3135         -0.7296          .    0.2162
married           0.1892        0.2108         -0.0552          .    0.0216
nodegree          0.7081        0.6378          0.1546          .    0.0703
re74           2095.5737     2342.1076         -0.0505     1.3289    0.0469
re75           1532.0553     1614.7451         -0.0257     1.4956    0.0452
           eCDF Max Std. Pair Dist.
distance     0.4216          0.9740
age          0.2541          1.3138
educ         0.0757          1.1668
raceblack    0.3730          1.0259
racehispan   0.1568          1.0743
racewhite    0.2162          0.9484
married      0.0216          0.8005
nodegree     0.0703          0.9155
re74         0.2757          0.7361
re75         0.2054          0.7057

Sample Sizes:
          Control Treated
All           429     185
Matched       185     185
Unmatched     244       0
Discarded       0       0</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model_4, <span class="at">type =</span> <span class="st">'jitter'</span>, <span class="at">interactive =</span> <span class="cn">FALSE</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="matching_files/figure-html/unnamed-chunk-61-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">summary</span>(model_4))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="matching_files/figure-html/unnamed-chunk-62-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model_4, <span class="at">type =</span> <span class="st">"qq"</span>, <span class="at">interactive =</span> <span class="cn">FALSE</span>, </span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>     <span class="at">wich.xs =</span> <span class="fu">c</span>(<span class="st">'age'</span>, <span class="st">'married'</span>, <span class="st">'re75'</span>, <span class="st">'re74'</span>, <span class="st">'educ'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="matching_files/figure-html/unnamed-chunk-63-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output-display">
<p><img src="matching_files/figure-html/unnamed-chunk-63-2.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output-display">
<p><img src="matching_files/figure-html/unnamed-chunk-63-3.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>model_4_t <span class="ot">&lt;-</span> <span class="fu">lm</span>(re78 <span class="sc">~</span> treat, <span class="at">data =</span> lalonde, <span class="at">weights =</span> model_4<span class="sc">$</span>weights) </span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_3_t)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = re78 ~ treat, data = lalonde, weights = model_3$weights)

Weighted Residuals:
   Min     1Q Median     3Q    Max 
 -5976      0      0      0  20842 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)   5618.1      617.6   9.097   &lt;2e-16 ***
treat          357.5      873.4   0.409    0.683    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 6237 on 202 degrees of freedom
Multiple R-squared:  0.0008287, Adjusted R-squared:  -0.004118 
F-statistic: 0.1675 on 1 and 202 DF,  p-value: 0.6828</code></pre>
</div>
</div>
</section>
<section id="полный-мэтчинг-мэтчатся-все-наблюдения-и-никто-не-выкидывается" class="level4" data-number="6.2.5.6">
<h4 data-number="6.2.5.6" class="anchored" data-anchor-id="полный-мэтчинг-мэтчатся-все-наблюдения-и-никто-не-выкидывается"><span class="header-section-number">6.2.5.6</span> Полный мэтчинг, мэтчатся все наблюдения и никто не выкидывается</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>model_5 <span class="ot">&lt;-</span> <span class="fu">matchit</span>(treat <span class="sc">~</span> age <span class="sc">+</span> educ <span class="sc">+</span> race <span class="sc">+</span> married <span class="sc">+</span> nodegree <span class="sc">+</span> re74 <span class="sc">+</span> re75, </span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> lalonde, <span class="at">method =</span> <span class="st">'full'</span>, <span class="at">link =</span> <span class="st">'probit'</span>)</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_5)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
matchit(formula = treat ~ age + educ + race + married + nodegree + 
    re74 + re75, data = lalonde, method = "full", link = "probit")

Summary of Balance for All Data:
           Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean
distance          0.5773        0.1817          1.8276     0.8777    0.3774
age              25.8162       28.0303         -0.3094     0.4400    0.0813
educ             10.3459       10.2354          0.0550     0.4959    0.0347
raceblack         0.8432        0.2028          1.7615          .    0.6404
racehispan        0.0595        0.1422         -0.3498          .    0.0827
racewhite         0.0973        0.6550         -1.8819          .    0.5577
married           0.1892        0.5128         -0.8263          .    0.3236
nodegree          0.7081        0.5967          0.2450          .    0.1114
re74           2095.5737     5619.2365         -0.7211     0.5181    0.2248
re75           1532.0553     2466.4844         -0.2903     0.9563    0.1342
           eCDF Max
distance     0.6413
age          0.1577
educ         0.1114
raceblack    0.6404
racehispan   0.0827
racewhite    0.5577
married      0.3236
nodegree     0.1114
re74         0.4470
re75         0.2876

Summary of Balance for Matched Data:
           Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean
distance          0.5773        0.5766          0.0036     0.9946    0.0042
age              25.8162       25.6335          0.0255     0.4674    0.0819
educ             10.3459       10.4590         -0.0562     0.6138    0.0221
raceblack         0.8432        0.8389          0.0119          .    0.0043
racehispan        0.0595        0.0469          0.0532          .    0.0126
racewhite         0.0973        0.1142         -0.0571          .    0.0169
married           0.1892        0.1555          0.0860          .    0.0337
nodegree          0.7081        0.6711          0.0814          .    0.0370
re74           2095.5737     2108.4175         -0.0026     1.3485    0.0330
re75           1532.0553     1557.1654         -0.0078     1.5659    0.0509
           eCDF Max Std. Pair Dist.
distance     0.0541          0.0197
age          0.2764          1.2686
educ         0.0595          1.1950
raceblack    0.0043          0.0162
racehispan   0.0126          0.5068
racewhite    0.0169          0.3978
married      0.0337          0.4866
nodegree     0.0370          0.9550
re74         0.2067          0.8421
re75         0.2059          0.8367

Sample Sizes:
              Control Treated
All            429.       185
Matched (ESS)   51.66     185
Matched        429.       185
Unmatched        0.         0
Discarded        0.         0</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model_5, <span class="at">type =</span> <span class="st">'jitter'</span>, <span class="at">interactive =</span> <span class="cn">FALSE</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="matching_files/figure-html/unnamed-chunk-66-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">summary</span>(model_5))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="matching_files/figure-html/unnamed-chunk-67-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model_5, <span class="at">type =</span> <span class="st">"qq"</span>, <span class="at">interactive =</span> <span class="cn">FALSE</span>, <span class="at">wich.xs =</span> <span class="fu">c</span>(<span class="st">'age'</span>, <span class="st">'married'</span>, <span class="st">'re75'</span>, <span class="st">'re74'</span>, <span class="st">'educ'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="matching_files/figure-html/unnamed-chunk-68-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output-display">
<p><img src="matching_files/figure-html/unnamed-chunk-68-2.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output-display">
<p><img src="matching_files/figure-html/unnamed-chunk-68-3.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>model_5_t <span class="ot">&lt;-</span> <span class="fu">lm</span>(re78 <span class="sc">~</span> treat, <span class="at">data =</span> lalonde, <span class="at">weights =</span> model_5<span class="sc">$</span>weights) </span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_5_t)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = re78 ~ treat, data = lalonde, weights = model_5$weights)

Weighted Residuals:
   Min     1Q Median     3Q    Max 
-19309  -2313   -190   2320  53959 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)   4517.0      309.7  14.587  &lt; 2e-16 ***
treat         1832.1      564.1   3.248  0.00123 ** 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 6414 on 612 degrees of freedom
Multiple R-squared:  0.01694,   Adjusted R-squared:  0.01534 
F-statistic: 10.55 on 1 and 612 DF,  p-value: 0.001227</code></pre>
</div>
</div>
</section>
</section>
<section id="сравнение-мэтчингов" class="level3" data-number="6.2.6">
<h3 data-number="6.2.6" class="anchored" data-anchor-id="сравнение-мэтчингов"><span class="header-section-number">6.2.6</span> Сравнение мэтчингов</h3>
<p>Из пакета <code>cobalt</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bal.tab</span>(treat <span class="sc">~</span> age <span class="sc">+</span> educ <span class="sc">+</span> race <span class="sc">+</span> married <span class="sc">+</span> re74 <span class="sc">+</span> re75,</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a><span class="at">data =</span> MatchIt<span class="sc">::</span>lalonde,</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a><span class="co"># links to mathing results</span></span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a><span class="at">weights =</span> <span class="fu">data.frame</span>(<span class="at">exact =</span> <span class="fu">get.w</span>(model_0),</span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>                     <span class="at">nearest =</span> <span class="fu">get.w</span>(model_1),</span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a>                     <span class="at">mahalanobis =</span> <span class="fu">get.w</span>(model_2)),</span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a><span class="co"># matching method ("matching" or "weighting")</span></span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a><span class="at">method =</span> <span class="fu">rep</span>(<span class="st">"matching"</span>, <span class="dv">3</span>),</span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a><span class="co"># standardized mean diffs. for binary vars.</span></span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a><span class="at">binary =</span> <span class="st">"std"</span>,</span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a><span class="at">disp.v.ratio =</span> <span class="cn">TRUE</span>,</span>
<span id="cb99-12"><a href="#cb99-12" aria-hidden="true" tabindex="-1"></a><span class="at">disp.ks =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Balance Measures
               Type Diff.exact V.Ratio.exact KS.exact Diff.nearest
age         Contin.          0        0.9927        0       0.0718
educ        Contin.          0        0.9927        0      -0.1290
race_black   Binary          0             .        0       1.0259
race_hispan  Binary          0             .        0      -0.6629
race_white   Binary          0             .        0      -0.7296
married      Binary          0             .        0      -0.0552
re74        Contin.          0             .        0      -0.0505
re75        Contin.          0             .        0      -0.0257
            V.Ratio.nearest KS.nearest Diff.mahalanobis V.Ratio.mahalanobis
age                  0.4568     0.2541           0.1254              0.5333
educ                 0.5721     0.0757          -0.0457              0.8306
race_black                .     0.3730           1.0407                   .
race_hispan               .     0.1568           0.0000                   .
race_white                .     0.2162          -1.2767                   .
married                   .     0.0216          -0.1518                   .
re74                 1.3289     0.2757          -0.2482              0.8710
re75                 1.4956     0.2054          -0.1331              1.0081
            KS.mahalanobis
age                 0.2324
educ                0.0486
race_black          0.3784
race_hispan         0.0000
race_white          0.3784
married             0.0595
re74                0.3405
re75                0.2216

Effective sample sizes
            Control Treated
All          429.    185.  
exact         11.26   12.18
nearest      185.    185.  
mahalanobis  185.    185.  </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bal.plot</span>(treat <span class="sc">~</span> age <span class="sc">+</span> educ <span class="sc">+</span> race <span class="sc">+</span> married <span class="sc">+</span> re74 <span class="sc">+</span> re75,</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="at">data =</span> MatchIt<span class="sc">::</span>lalonde,</span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a><span class="co"># links to mathing results</span></span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a><span class="at">weights =</span> <span class="fu">data.frame</span>(<span class="at">exact =</span> <span class="fu">get.w</span>(model_0),</span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>                     <span class="at">nearest =</span> <span class="fu">get.w</span>(model_1),</span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>                     <span class="at">mahalanobis =</span> <span class="fu">get.w</span>(model_2)),</span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a><span class="co"># matching method ("matching" or "weighting")</span></span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a><span class="at">method =</span> <span class="fu">rep</span>(<span class="st">"matching"</span>, <span class="dv">3</span>),</span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a><span class="at">var.name =</span> <span class="st">"age"</span>,</span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a><span class="at">which =</span> <span class="st">"both"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="matching_files/figure-html/unnamed-chunk-71-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bal.plot</span>(treat <span class="sc">~</span> age <span class="sc">+</span> educ <span class="sc">+</span> race <span class="sc">+</span> married <span class="sc">+</span> re74 <span class="sc">+</span> re75,</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a><span class="at">data =</span> MatchIt<span class="sc">::</span>lalonde,</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a><span class="co"># links to mathing results</span></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a><span class="at">weights =</span> <span class="fu">data.frame</span>(<span class="at">exact =</span> <span class="fu">get.w</span>(model_0),</span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>                     <span class="at">nearest =</span> <span class="fu">get.w</span>(model_1),</span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>                     <span class="at">mahalanobis =</span> <span class="fu">get.w</span>(model_2)),</span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a><span class="co"># matching method ("matching" or "weighting")</span></span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a><span class="at">method =</span> <span class="fu">rep</span>(<span class="st">"matching"</span>, <span class="dv">3</span>),</span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a><span class="at">var.name =</span> <span class="st">"married"</span>,</span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a><span class="at">which =</span> <span class="st">"both"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="matching_files/figure-html/unnamed-chunk-72-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="fu">love.plot</span>(treat <span class="sc">~</span> age <span class="sc">+</span> educ <span class="sc">+</span> race <span class="sc">+</span> married <span class="sc">+</span> re74 <span class="sc">+</span> re75,</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a><span class="at">data =</span> MatchIt<span class="sc">::</span>lalonde,</span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a><span class="at">weights =</span> <span class="fu">data.frame</span>(<span class="at">exact =</span> <span class="fu">get.w</span>(model_0),</span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">nearest =</span> <span class="fu">get.w</span>(model_1),</span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>                     <span class="at">mahalanobis =</span> <span class="fu">get.w</span>(model_2)),</span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a><span class="at">method =</span> <span class="fu">c</span>(<span class="st">"matching"</span>, <span class="st">"matching"</span>, <span class="st">"matching"</span>),</span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a><span class="co"># link method-specific dots</span></span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a><span class="at">line =</span> <span class="cn">TRUE</span>,</span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a><span class="at">binary =</span> <span class="st">"std"</span>,</span>
<span id="cb103-10"><a href="#cb103-10" aria-hidden="true" tabindex="-1"></a><span class="co"># set thresholds for mean diffs.</span></span>
<span id="cb103-11"><a href="#cb103-11" aria-hidden="true" tabindex="-1"></a><span class="at">threshold =</span> <span class="fl">0.1</span>,</span>
<span id="cb103-12"><a href="#cb103-12" aria-hidden="true" tabindex="-1"></a><span class="at">shapes =</span> <span class="fu">c</span>(<span class="st">"circle"</span>, <span class="st">"square"</span>,</span>
<span id="cb103-13"><a href="#cb103-13" aria-hidden="true" tabindex="-1"></a><span class="st">"triangle"</span>, <span class="st">"diamond"</span>)) <span class="sc">+</span></span>
<span id="cb103-14"><a href="#cb103-14" aria-hidden="true" tabindex="-1"></a><span class="fu">scale_colour_hue</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="matching_files/figure-html/unnamed-chunk-73-1.png" class="img-fluid" width="672"></p>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./subclassification.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Взвешивание (subclassification)</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./high_dimension_regularization.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Регуляризация и большая размерность</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
 Анна Ставнийчук, Прикладная эконометрика, 2023
  </li>  
</ul>
    </div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>



</body></html>